<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Nuerlo</title>
    
    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/assets/images/NUERLO-LOGO.png">
    
    <!-- Mobile Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Nuerlo">
    <meta name="theme-color" content="#ffffff" id="themeColorMeta">
    
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Dashboard Styles Only -->
    <link rel="stylesheet" href="/dashboard-styles.css">
    
    <!-- Cropper.js for image cropping -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    
    <style>
        /* Prevent content flash - hide body content until auth completes */
        body:not(.auth-ready) > #authProtectedContent {
            display: none !important;
        }
    </style>
    <script>
        // Safety fallback: Force show content after 5 seconds if auth check fails
        // This prevents white screen if JavaScript errors occur
        setTimeout(function() {
            try {
                const body = document.body;
                const content = document.getElementById('authProtectedContent');
                if (content && !body.classList.contains('auth-ready')) {
                    console.warn('Safety fallback triggered: Forcing content to show after 5s timeout');
                    body.classList.add('auth-ready');
                    content.style.display = 'block';
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) {
                        loadingScreen.classList.add('hidden');
                        loadingScreen.style.display = 'none';
                    }
                }
            } catch (e) {
                console.error('Safety fallback error:', e);
                // Last resort: try to show content anyway
                try {
                    const content = document.getElementById('authProtectedContent');
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (content) content.style.display = 'block';
                    if (loadingScreen) {
                        loadingScreen.style.display = 'none';
                        loadingScreen.classList.add('hidden');
                    }
                    document.body.classList.add('auth-ready');
                } catch (e2) {
                    console.error('Last resort fallback also failed:', e2);
                }
            }
        }, 5000);
    </script>
</head>
<body class="dashboard-body">
    
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-logo">
            <img src="/assets/images/LOGO.png" alt="Nuerlo">
        </div>
    </div>

    <!-- Auth Protected Content - Hidden until Firebase confirms authentication -->
    <div id="authProtectedContent" class="auth-protected-content" style="display: none;">
    <!-- Sidebar -->
    <nav class="dashboard-sidebar" id="sidebar">
        <button class="sidebar-collapse-btn" id="sidebarToggle" title="Collapse sidebar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <!-- Mobile Profile Section -->
        <div class="sidebar-mobile-profile" id="sidebarMobileProfile">
            <button class="sidebar-mobile-close-btn" onclick="toggleSidebar()" title="Close menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="sidebar-mobile-profile-picture" id="sidebarMobileProfilePicture"></div>
            <div class="sidebar-mobile-profile-name" id="sidebarMobileProfileName"></div>
            <div class="sidebar-mobile-profile-email" id="sidebarMobileProfileEmail"></div>
        </div>
        
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="/assets/images/LOGO.png" alt="Nuerlo">
            </div>
        </div>
        
        <div class="sidebar-content">
            <div class="sidebar-section">
                <div class="sidebar-section-title">Main</div>
                <ul class="sidebar-nav">
                    <li class="nav-item active">
                        <a href="#overview" class="nav-link" data-section="overview" data-tooltip="Overview">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#programs" class="nav-link" data-section="programs" data-tooltip="My Programs">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                            <span>My Programs</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#progress" class="nav-link" data-section="progress" data-tooltip="Progress">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                            </svg>
                            <span>Progress</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#resources" class="nav-link" data-section="resources" data-tooltip="Resources">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            </svg>
                            <span>Resources</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-section-title">Resources</div>
                <ul class="sidebar-nav">
                    <li class="nav-item">
                        <a href="#marketplace" class="nav-link" data-section="marketplace" data-tooltip="Marketplace">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="9" cy="21" r="1"></circle>
                                <circle cx="20" cy="21" r="1"></circle>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                            </svg>
                            <span>Marketplace</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tasks" class="nav-link" data-section="tasks" data-tooltip="Tasks">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 11l3 3 8-8"></path>
                                <path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h9"></path>
                            </svg>
                            <span>Tasks</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#notes" class="nav-link" data-section="notes" data-tooltip="Notes">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            <span>Notes</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-section-title">Account</div>
                <ul class="sidebar-nav">
                    <li class="nav-item">
                        <a href="#payment" class="nav-link" data-section="payment" data-tooltip="Payment">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            <span>Payment</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#help" class="nav-link" data-section="help" data-tooltip="Help">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <span>Help</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#profile" class="nav-link" data-section="profile" data-tooltip="Profile">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span>Profile</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#settings" class="nav-link" data-section="settings" data-tooltip="Settings">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#logout" class="nav-link" id="logoutBtn" onclick="handleLogout(); return false;" data-tooltip="Logout">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Header -->
        <header class="dashboard-header">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            
            <div class="header-left">
                <h1 class="dashboard-title">
                    <span id="titleText">Welcome, </span><span id="userName"></span>
                </h1>
            </div>
            
            <div class="header-center">
                <div class="header-search-bar">
                    <svg class="header-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <input type="text" class="header-search-input" placeholder="Search..." id="headerSearchInput" autocomplete="off">
                    <button class="header-search-clear" id="headerSearchClear" style="display: none;">Ã—</button>
                    <div class="header-search-shortcut">/</div>
                    <div class="header-search-dropdown" id="headerSearchDropdown">
                        <div class="header-search-suggestions" id="headerSearchSuggestions"></div>
                    </div>
                </div>
                </div>
            
            <div class="header-right">
                <div class="header-actions">
                    <button class="header-icon-btn theme-toggle-btn" id="themeToggle" title="Toggle theme">
                        <!-- Sun icon for dark mode (to switch to light) -->
                        <svg class="theme-icon theme-icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <!-- Moon icon for light mode (to switch to dark) -->
                        <svg class="theme-icon theme-icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                    <button class="header-icon-btn notification-btn" id="notificationBtn" title="Notifications">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <button class="header-icon-btn add-btn" id="addBtn" title="Quick Actions">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                </div>
                <!-- Notifications Dropdown -->
                <div class="notifications-dropdown header-dropdown" id="notificationsDropdown">
                    <div class="notifications-header">
                        <span class="notifications-title">Notifications</span>
                    </div>
                    <div class="notifications-content">
                        <div class="notification-empty">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                            </svg>
                            <p>No new notifications</p>
                        </div>
                    </div>
                </div>
                <!-- Add Dropdown -->
                <div class="add-dropdown header-dropdown" id="addDropdown">
                    <div class="add-dropdown-content">
                        <button class="add-dropdown-item" data-section="profile" onclick="navigateToSection('profile'); hideAddDropdown(); return false;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span>Profile</span>
                        </button>
                        <button class="add-dropdown-item" data-section="payment" onclick="navigateToSection('payment'); hideAddDropdown(); return false;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            <span>Payment</span>
                        </button>
                        <button class="add-dropdown-item" data-section="settings" onclick="navigateToSection('settings'); hideAddDropdown(); return false;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            <span>Settings</span>
                        </button>
                        <button class="add-dropdown-item" data-section="help" onclick="navigateToSection('help'); hideAddDropdown(); return false;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <span>Help</span>
                        </button>
                        <div class="add-dropdown-divider"></div>
                        <button class="add-dropdown-item" onclick="handleLogout(); hideAddDropdown(); return false;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
                <div class="user-profile-mini" onclick="navigateToSection('profile')">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span class="user-name-mini" id="userNameMini"></span>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            
            <!-- Overview Section -->
            <section id="overview" class="content-section active">
                <!-- Continue Learning -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Continue Learning</h3>
                        <a href="#programs" class="card-action" onclick="navigateToSection('programs'); return false;">View all</a>
                        </div>
                    <div id="continueContainer">
                        <div id="continueLoading" style="text-align: center; padding: 2rem 0; color: var(--color-text-tertiary); display: none;">
                            <div style="display: inline-block; width: 20px; height: 20px; border: 2px solid var(--color-border-light); border-top-color: var(--color-brand-purple); border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
                                </div>
                        <div id="continueCourse" style="display: none;">
                            <div class="program-card" onclick="resumeCourse()">
                                <div class="program-thumbnail" id="continueThumbnail">
                                    <img src="" alt="Course" id="continueThumbnailImg" style="display: none;">
                                </div>
                                <div class="program-content">
                                    <div class="program-header">
                                        <h4 class="program-title" id="continueTitle">Course Title</h4>
                                        <div class="program-meta">
                                            <span id="continueMeta">12 lessons</span>
                                        </div>
                                    </div>
                                    <div class="program-progress">
                                        <div class="progress-label">
                                            <span>Progress</span>
                                            <span id="continueProgress">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="continueProgressBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" onclick="event.stopPropagation(); resumeCourse()">Continue</button>
                                </div>
                            </div>
                        </div>
                        <div id="noCourses" style="text-align: center; padding: 3rem 1rem; display: none;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1rem; opacity: 0.2;">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                                </svg>
                            <p style="color: var(--color-text-secondary); margin-bottom: 0.5rem; font-weight: var(--font-weight-medium);">Start learning</p>
                            <p style="color: var(--color-text-tertiary); margin-bottom: 1.5rem; font-size: var(--font-size-sm);">Explore courses in the marketplace</p>
                            <button class="btn btn-primary" onclick="navigateToSection('marketplace')">Browse Marketplace</button>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recommended for You</h3>
                        <a href="#marketplace" class="card-action" onclick="navigateToSection('marketplace'); return false;">See more</a>
                            </div>
                    <div class="programs-grid" id="recommendedGrid">
                        <!-- Recommended courses will be loaded here -->
                        </div>
                </div>
            </section>

            <!-- Programs Section -->
            <section id="programs" class="content-section">
                <!-- Programs Tabs Navigation - COMPLETELY SEPARATE -->
                <div class="payment-nav-container">
                    <button class="payment-nav-btn payment-nav-active" data-programs-section="allProgramsSection">
                        All Programs
                    </button>
                    <button class="payment-nav-btn" data-programs-section="notStartedSection">
                        Not Started
                    </button>
                    <button class="payment-nav-btn" data-programs-section="inProgressSection">
                        In Progress
                    </button>
                    <button class="payment-nav-btn" data-programs-section="completedSection">
                        Completed
                    </button>
                    <div class="payment-nav-underline"></div>
                </div>

                <!-- All Programs Subsection -->
                <div id="allProgramsSection" class="profile-subsection active">
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <!-- Programs Grid -->
                            <div class="programs-grid" id="programsGrid" data-filter="all">
                                <!-- Loading State -->
                                <div id="programsLoading" style="grid-column: 1/-1; text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                                    <div style="display: inline-block; width: 24px; height: 24px; border: 2px solid var(--color-border-light); border-top-color: var(--color-brand-purple); border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
                                </div>

                                <!-- Empty State -->
                                <div id="noProgramsMessage" style="grid-column: 1/-1; text-align: center; padding: 3rem 1rem; display: none;">
                                    <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1.5rem; opacity: 0.2;">
                                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                                    </svg>
                                    <h3 style="color: var(--color-text-primary); margin-bottom: 0.5rem; font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);">No programs enrolled</h3>
                                    <p style="color: var(--color-text-tertiary); margin-bottom: 2rem; font-size: var(--font-size-sm);">Discover courses tailored to your interests</p>
                                    <button class="btn btn-primary" onclick="navigateToSection('marketplace')">Browse Marketplace</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Not Started Subsection -->
                <div id="notStartedSection" class="profile-subsection" style="display: none;">
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <!-- Programs Grid -->
                            <div class="programs-grid" id="programsGridNotStarted" data-filter="not-started">
                                <!-- Loading State -->
                                <div id="programsLoadingNotStarted" style="grid-column: 1/-1; text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                                    <div style="display: inline-block; width: 24px; height: 24px; border: 2px solid var(--color-border-light); border-top-color: var(--color-brand-purple); border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
                                </div>

                                <!-- Empty State -->
                                <div id="noProgramsMessageNotStarted" style="grid-column: 1/-1; text-align: center; padding: 3rem 1rem; display: none;">
                                    <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1.5rem; opacity: 0.2;">
                                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                                    </svg>
                                    <h3 style="color: var(--color-text-primary); margin-bottom: 0.5rem; font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);">No programs not started</h3>
                                    <p style="color: var(--color-text-tertiary); margin-bottom: 2rem; font-size: var(--font-size-sm);">You've started all your enrolled programs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- In Progress Subsection -->
                <div id="inProgressSection" class="profile-subsection" style="display: none;">
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <!-- Programs Grid -->
                            <div class="programs-grid" id="programsGridInProgress" data-filter="in-progress">
                                <!-- Loading State -->
                                <div id="programsLoadingInProgress" style="grid-column: 1/-1; text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                                    <div style="display: inline-block; width: 24px; height: 24px; border: 2px solid var(--color-border-light); border-top-color: var(--color-brand-purple); border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
                                </div>

                                <!-- Empty State -->
                                <div id="noProgramsMessageInProgress" style="grid-column: 1/-1; text-align: center; padding: 3rem 1rem; display: none;">
                                    <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1.5rem; opacity: 0.2;">
                                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                                    </svg>
                                    <h3 style="color: var(--color-text-primary); margin-bottom: 0.5rem; font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);">No programs in progress</h3>
                                    <p style="color: var(--color-text-tertiary); margin-bottom: 2rem; font-size: var(--font-size-sm);">Start a program to see it here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Completed Subsection -->
                <div id="completedSection" class="profile-subsection" style="display: none;">
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <!-- Programs Grid -->
                            <div class="programs-grid" id="programsGridCompleted" data-filter="completed">
                                <!-- Loading State -->
                                <div id="programsLoadingCompleted" style="grid-column: 1/-1; text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                                    <div style="display: inline-block; width: 24px; height: 24px; border: 2px solid var(--color-border-light); border-top-color: var(--color-brand-purple); border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
                                </div>

                                <!-- Empty State -->
                                <div id="noProgramsMessageCompleted" style="grid-column: 1/-1; text-align: center; padding: 3rem 1rem; display: none;">
                                    <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1.5rem; opacity: 0.2;">
                                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                                    </svg>
                                    <h3 style="color: var(--color-text-primary); margin-bottom: 0.5rem; font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);">No completed programs</h3>
                                    <p style="color: var(--color-text-tertiary); margin-bottom: 2rem; font-size: var(--font-size-sm);">Complete a program to see it here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                // PROGRAMS NAVIGATION - COMPLETELY SEPARATE SYSTEM
                (function() {
                    let updateUnderlineFunction = null;
                    
                    function setupProgramsNav() {
                        const programsSection = document.getElementById('programs');
                        if (!programsSection) return;
                        
                        const navContainer = programsSection.querySelector('.payment-nav-container');
                        const navButtons = programsSection.querySelectorAll('.payment-nav-btn');
                        const underline = programsSection.querySelector('.payment-nav-underline');
                        
                        if (!navContainer || !navButtons.length || !underline) {
                            console.log('Programs nav elements not ready');
                            return;
                        }
                        
                        // Check URL for subsection first
                        const urlInfo = typeof parseSectionFromUrl === 'function' ? parseSectionFromUrl() : null;
                        let activeSectionId = null;
                        
                        // If URL has programs subsection, set that as active
                        if (urlInfo && urlInfo.section === 'programs' && urlInfo.subsection) {
                            const subsectionMap = {
                                'all': 'allProgramsSection',
                                'not-started': 'notStartedSection',
                                'in-progress': 'inProgressSection',
                                'completed': 'completedSection'
                            };
                            activeSectionId = subsectionMap[urlInfo.subsection];
                            console.log('[setupProgramsNav] Setting from URL:', urlInfo.subsection, '->', activeSectionId);
                        }
                        
                        // Check which tab is active and sync content with it
                        let activeBtn = programsSection.querySelector('.payment-nav-btn.payment-nav-active');
                        
                        // If we have a URL-based section, find and activate that button
                        if (activeSectionId) {
                            navButtons.forEach(function(b) { b.classList.remove('payment-nav-active'); });
                            const targetBtn = Array.from(navButtons).find(b => b.getAttribute('data-programs-section') === activeSectionId);
                            if (targetBtn) {
                                targetBtn.classList.add('payment-nav-active');
                                activeBtn = targetBtn;
                            }
                        }
                        
                        // If no active button, default to all programs
                        if (!activeBtn) {
                            navButtons.forEach(function(b) { b.classList.remove('payment-nav-active'); });
                            navButtons[0].classList.add('payment-nav-active');
                            activeBtn = navButtons[0];
                            activeSectionId = navButtons[0].getAttribute('data-programs-section');
                        } else if (!activeSectionId) {
                            // Get the section ID from the active button
                            activeSectionId = activeBtn.getAttribute('data-programs-section');
                        }
                        
                        // Hide all subsections first
                        programsSection.querySelectorAll('.profile-subsection').forEach(function(s) {
                            s.style.display = 'none';
                            s.classList.remove('active');
                        });
                        
                        // Show the subsection that matches the active tab
                        const targetSubsection = document.getElementById(activeSectionId);
                        if (targetSubsection) {
                            targetSubsection.style.display = 'block';
                            targetSubsection.classList.add('active');
                            
                            // Trigger filter update when switching tabs
                            const filterType = targetSubsection.querySelector('.programs-grid')?.getAttribute('data-filter') || 'all';
                            if (window.updateProgramsFilter) {
                                window.updateProgramsFilter(filterType);
                            }
                        } else {
                            // Fallback to all programs if target not found
                            const allProgramsSection = document.getElementById('allProgramsSection');
                            if (allProgramsSection) {
                                allProgramsSection.style.display = 'block';
                                allProgramsSection.classList.add('active');
                            }
                        }
                        
                        function updateUnderline(btn) {
                            if (!btn || !navContainer || !underline) return;
                            
                            // Use requestAnimationFrame to ensure layout is ready
                            requestAnimationFrame(function() {
                                const btnRect = btn.getBoundingClientRect();
                                const containerRect = navContainer.getBoundingClientRect();
                                
                                if (btnRect.width > 0 && containerRect.width > 0) {
                                    const left = btnRect.left - containerRect.left;
                                    const width = btnRect.width;
                                    
                                    underline.style.left = left + 'px';
                                    underline.style.width = width + 'px';
                                    underline.style.display = 'block';
                                    underline.style.opacity = '1';
                                    underline.style.visibility = 'visible';
                                } else {
                                    // Retry if not ready
                                    setTimeout(function() { updateUnderline(btn); }, 50);
                                }
                            });
                        }
                        
                        // Store function globally so it can be called from search
                        updateUnderlineFunction = updateUnderline;
                        window.updateProgramsUnderline = function(subsectionId) {
                            const btn = programsSection.querySelector(`.payment-nav-btn[data-programs-section="${subsectionId}"]`);
                            if (btn) {
                                updateUnderline(btn);
                                setTimeout(() => updateUnderline(btn), 50);
                                setTimeout(() => updateUnderline(btn), 150);
                            }
                        };
                        
                        // Position underline immediately
                        const currentActive = programsSection.querySelector('.payment-nav-btn.payment-nav-active') || navButtons[0];
                        updateUnderline(currentActive);
                        
                        // Also try multiple times to ensure it works
                        setTimeout(function() { updateUnderline(currentActive); }, 50);
                        setTimeout(function() { updateUnderline(currentActive); }, 150);
                        setTimeout(function() { updateUnderline(currentActive); }, 300);
                        
                        // Click handlers
                        navButtons.forEach(function(btn) {
                            btn.onclick = function() {
                                navButtons.forEach(function(b) { b.classList.remove('payment-nav-active'); });
                                this.classList.add('payment-nav-active');
                                updateUnderline(this);
                                
                                const sectionId = this.getAttribute('data-programs-section');
                                programsSection.querySelectorAll('.profile-subsection').forEach(function(s) {
                                    s.style.display = 'none';
                                    s.classList.remove('active');
                                });
                                
                                const target = document.getElementById(sectionId);
                                if (target) {
                                    target.style.display = 'block';
                                    target.classList.add('active');
                                    
                                    // Trigger filter update when switching tabs
                                    const filterType = target.querySelector('.programs-grid')?.getAttribute('data-filter') || 'all';
                                    if (window.updateProgramsFilter) {
                                        window.updateProgramsFilter(filterType);
                                    }
                                    
                                    // Update URL with subsection
                                    const subsectionMap = {
                                        'allProgramsSection': 'all',
                                        'notStartedSection': 'not-started',
                                        'inProgressSection': 'in-progress',
                                        'completedSection': 'completed'
                                    };
                                    const subsectionName = subsectionMap[sectionId];
                                    if (subsectionName && typeof updateUrlForSubsection === 'function') {
                                        updateUrlForSubsection('programs', subsectionName);
                                    }
                                }
                            };
                        });
                    }
                    
                    // Initialize on load
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', setupProgramsNav);
                    } else {
                        setupProgramsNav();
                    }
                    
                    // Retry setup multiple times to ensure it works
                    setTimeout(setupProgramsNav, 100);
                    setTimeout(setupProgramsNav, 300);
                    setTimeout(setupProgramsNav, 600);
                    setTimeout(setupProgramsNav, 1000);
                    
                    // Watch for programs section activation
                    const programsSection = document.getElementById('programs');
                    if (programsSection) {
                        const observer = new MutationObserver(function() {
                            if (programsSection.classList.contains('active')) {
                                setTimeout(setupProgramsNav, 50);
                            }
                        });
                        observer.observe(programsSection, { attributes: true, attributeFilter: ['class'] });
                    }
                })();
                </script>
            </section>

                                    <!-- Progress Section -->
            <section id="progress" class="content-section">
                <!-- Progress Tabs Navigation -->
                <div class="progress-nav-container">
                    <button class="progress-nav-btn progress-nav-active" data-progress-section="chartSection">
                        Progress
                    </button>
                    <button class="progress-nav-btn" data-progress-section="statsSection">
                        Stats
                    </button>
                    <button class="progress-nav-btn" data-progress-section="activitySection">
                        Activity
                    </button>
                    <div class="progress-nav-underline"></div>
                </div>

                <!-- Chart Section (Main) -->
                <div id="chartSection" class="profile-subsection active">
                    <!-- Custom Dropdown -->
                    <div class="custom-dropdown-container" style="margin-bottom: var(--space-6);">
                        <div class="custom-dropdown" id="customDropdown">
                            <div class="custom-dropdown-selected" id="dropdownSelected">
                                <span id="selectedCourseText">Select course...</span>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                            <div class="custom-dropdown-options" id="dropdownOptions">
                                <!-- Options will be populated here -->
                            </div>
                        </div>
                        <span id="courseProgressText" style="color: var(--color-text-tertiary); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); margin-left: var(--space-3);"></span>
                    </div>
                    
                    <!-- No Courses Message -->
                    <div id="noCoursesMessage" style="display: none; text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                        <p style="color: var(--color-text-secondary); margin-bottom: 0.5rem; font-weight: var(--font-weight-medium);">No courses enrolled</p>
                        <p style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">Enroll in courses from the Marketplace to track your progress</p>
                    </div>
                    
                    <!-- Progress Chart -->
                    <div style="width: 100%; height: 300px; position: relative; margin-bottom: var(--space-8);">
                        <canvas id="progressLineChart" style="width: 100%; height: 100%;"></canvas>
                    </div>
                    
                    <!-- Course Details -->
                    <div id="courseDetailsSection" class="profile-info-container">
                        <div class="profile-info-content" id="courseDetailsContent">
                            <!-- Details will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Stats Subsection -->
                <div id="statsSection" class="profile-subsection" style="display: none;">
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <div class="profile-field">
                                <div class="profile-field-label">Total Learning Time</div>
                                <div class="profile-field-value">
                                    <span id="totalLearningTime">0 minutes</span>
                                </div>
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Courses Enrolled</div>
                                <div class="profile-field-value">
                                    <span id="totalCoursesEnrolled">0</span>
                                </div>
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Courses Completed</div>
                                <div class="profile-field-value">
                                    <span id="totalCoursesCompleted">0</span>
                                </div>
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Current Streak</div>
                                <div class="profile-field-value">
                                    <span id="currentStreak">0 days</span>
                                </div>
                            </div>
                            
                            <div class="profile-field" style="border-bottom: none;">
                                <div class="profile-field-label">Last Active</div>
                                <div class="profile-field-value">
                                    <span id="lastActive" style="color: var(--color-text-tertiary);">No activity yet</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Subsection -->
                <div id="activitySection" class="profile-subsection" style="display: none;">
                    <div class="profile-info-container">
                        <div class="profile-info-content" id="activityContent">
                            <div style="text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                                <p style="color: var(--color-text-secondary); margin-bottom: 0.5rem; font-weight: var(--font-weight-medium);">No recent activity</p>
                                <p style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">Your learning activity will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                // PROGRESS NAVIGATION
                (function() {
                    function setupProgressNav() {
                        const progressSection = document.getElementById('progress');
                        if (!progressSection) return;
                        
                        const navContainer = progressSection.querySelector('.progress-nav-container');
                        const navButtons = progressSection.querySelectorAll('.progress-nav-btn');
                        const underline = progressSection.querySelector('.progress-nav-underline');
                        
                        if (!navContainer || !navButtons.length || !underline) {
                            console.log('Progress nav elements not ready');
                            return;
                        }
                        
                        // Check URL for subsection first
                        const urlInfo = typeof parseSectionFromUrl === 'function' ? parseSectionFromUrl() : null;
                        let activeSectionId = null;
                        
                        // If URL has progress subsection, set that as active
                        if (urlInfo && urlInfo.section === 'progress' && urlInfo.subsection) {
                            const subsectionMap = {
                                'progress': 'chartSection',
                                'chart': 'chartSection',
                                'stats': 'statsSection',
                                'activity': 'activitySection'
                            };
                            activeSectionId = subsectionMap[urlInfo.subsection];
                            console.log('[setupProgressNav] Setting from URL:', urlInfo.subsection, '->', activeSectionId);
                        }
                        
                        let activeBtn = progressSection.querySelector('.progress-nav-btn.progress-nav-active');
                        
                        // If we have a URL-based section, find and activate that button
                        if (activeSectionId) {
                            navButtons.forEach(function(b) { b.classList.remove('progress-nav-active'); });
                            const targetBtn = Array.from(navButtons).find(b => b.getAttribute('data-progress-section') === activeSectionId);
                            if (targetBtn) {
                                targetBtn.classList.add('progress-nav-active');
                                activeBtn = targetBtn;
                            }
                        }
                        
                        if (!activeBtn) {
                            navButtons.forEach(function(b) { b.classList.remove('progress-nav-active'); });
                            navButtons[0].classList.add('progress-nav-active');
                            activeBtn = navButtons[0];
                            activeSectionId = navButtons[0].getAttribute('data-progress-section');
                        } else if (!activeSectionId) {
                            activeSectionId = activeBtn.getAttribute('data-progress-section');
                        }
                        
                        progressSection.querySelectorAll('.profile-subsection').forEach(function(s) {
                            s.style.display = 'none';
                            s.classList.remove('active');
                        });
                        
                        const targetSubsection = document.getElementById(activeSectionId);
                        if (targetSubsection) {
                            targetSubsection.style.display = 'block';
                            targetSubsection.classList.add('active');
                        } else {
                            const chartSection = document.getElementById('chartSection');
                            if (chartSection) {
                                chartSection.style.display = 'block';
                                chartSection.classList.add('active');
                            }
                        }
                        
                        function updateUnderline(btn) {
                            if (!btn || !navContainer || !underline) return;
                            
                            requestAnimationFrame(function() {
                                const btnRect = btn.getBoundingClientRect();
                                const containerRect = navContainer.getBoundingClientRect();
                                
                                if (btnRect.width > 0 && containerRect.width > 0) {
                                    const left = btnRect.left - containerRect.left;
                                    const width = btnRect.width;
                                    
                                    underline.style.left = left + 'px';
                                    underline.style.width = width + 'px';
                                    underline.style.display = 'block';
                                    underline.style.opacity = '1';
                                    underline.style.visibility = 'visible';
                                } else {
                                    setTimeout(function() { updateUnderline(btn); }, 50);
                                }
                            });
                        }
                        
                        const currentActive = progressSection.querySelector('.progress-nav-btn.progress-nav-active') || navButtons[0];
                        updateUnderline(currentActive);
                        
                        setTimeout(function() { updateUnderline(currentActive); }, 50);
                        setTimeout(function() { updateUnderline(currentActive); }, 150);
                        
                        navButtons.forEach(function(btn) {
                            btn.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                const targetSectionId = btn.getAttribute('data-progress-section');
                                if (!targetSectionId) return;
                                
                                navButtons.forEach(function(b) { b.classList.remove('progress-nav-active'); });
                                btn.classList.add('progress-nav-active');
                                
                                progressSection.querySelectorAll('.profile-subsection').forEach(function(s) {
                                    s.style.display = 'none';
                                    s.classList.remove('active');
                                });
                                
                                const targetSection = document.getElementById(targetSectionId);
                                if (targetSection) {
                                    targetSection.style.display = 'block';
                                    setTimeout(function() {
                                        targetSection.classList.add('active');
                                        
                                        // Redraw chart if switching to chart section
                                        if (targetSectionId === 'chartSection' && window.chartProgressData) {
                                            setTimeout(function() {
                                                if (window.drawLineChartGlobal) {
                                                    window.drawLineChartGlobal(window.chartProgressData);
                                                }
                                            }, 100);
                                        }
                                    }, 10);
                                    
                                    // Update URL with subsection
                                    const subsectionMap = {
                                        'chartSection': 'progress',
                                        'statsSection': 'stats',
                                        'activitySection': 'activity'
                                    };
                                    const subsectionName = subsectionMap[targetSectionId];
                                    if (subsectionName && typeof updateUrlForSubsection === 'function') {
                                        updateUrlForSubsection('progress', subsectionName);
                                    }
                                }
                                
                                updateUnderline(btn);
                                setTimeout(function() { updateUnderline(btn); }, 50);
                            });
                        });
                    }
                    
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() {
                            setTimeout(setupProgressNav, 100);
                        });
                    } else {
                        setTimeout(setupProgressNav, 100);
                    }
                })();
                </script>
            </section>

            <!-- Resources Section -->
            <section id="resources" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Saved Resources</h3>
                    </div>
                    <div class="programs-grid" id="resourcesGrid">
                        <div style="grid-column: 1/-1; text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1rem; opacity: 0.2;">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                            <p style="color: var(--color-text-secondary); margin-bottom: 0.5rem; font-weight: var(--font-weight-medium);">No saved resources</p>
                            <p style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">Save courses, articles, and materials for quick access</p>
                        </div>
                    </div>
                    </div>
            </section>

            <!-- Marketplace Section -->
            <section id="marketplace" class="content-section">
                <!-- Search -->
                    <div class="search-container">
                        <div class="marketplace-search-wrapper" id="marketplaceSearchWrapper">
                        <svg class="marketplace-search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="M21 21l-4.35-4.35"></path>
                            </svg>
                        <input type="text" class="marketplace-search-input" placeholder="Search programs..." id="marketplaceSearch" autocomplete="off">
                        <div class="marketplace-search-dropdown" id="marketplaceSearchDropdown" style="display: none;">
                            <div class="marketplace-search-suggestions" id="marketplaceSearchSuggestions"></div>
                        </div>
                    </div>
                    <button class="filter-toggle-btn" onclick="toggleFilters()" id="marketplaceFilterToggle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="4" y1="21" x2="4" y2="14"></line>
                            <line x1="4" y1="10" x2="4" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12" y2="3"></line>
                            <line x1="20" y1="21" x2="20" y2="16"></line>
                            <line x1="20" y1="12" x2="20" y2="3"></line>
                            <line x1="1" y1="14" x2="7" y2="14"></line>
                            <line x1="9" y1="8" x2="15" y2="8"></line>
                            <line x1="17" y1="16" x2="23" y2="16"></line>
                                </svg>
                            </button>
                            </div>
                                
                <!-- Marketplace Grid -->
                <div class="programs-grid" id="marketplaceGrid">
                    <!-- Loading State -->
                    <div id="marketplaceLoading" style="grid-column: 1/-1; text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                        <div style="display: inline-block; width: 24px; height: 24px; border: 2px solid var(--color-border-light); border-top-color: var(--color-brand-purple); border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
                                        </div>
                                    </div>
            </section>

            <!-- Tasks Section -->
            <section id="tasks" class="content-section">
                <div class="card">
                    <div style="text-align: center; padding: 3rem 1rem;">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1.5rem; opacity: 0.2;">
                            <path d="M9 11l3 3 8-8"></path>
                            <path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h9"></path>
                        </svg>
                        <h3 style="color: var(--color-text-primary); margin-bottom: 0.5rem; font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);">No tasks</h3>
                        <p style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">Assignments and deadlines will appear here</p>
                    </div>
                </div>
            </section>

            <!-- Notes Section -->
            <section id="notes" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <a href="#" class="card-action" onclick="createNewNote(); return false;">New Note</a>
                    </div>
                    <div id="notesList" style="display: flex; flex-direction: column; gap: var(--space-3);">
                        <div style="text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1rem; opacity: 0.2;">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            <p style="color: var(--color-text-secondary); margin-bottom: 0.5rem; font-weight: var(--font-weight-medium);">No notes yet</p>
                            <p style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">Create notes to track your learning and ideas</p>
                        </div>
                        </div>
                    </div>
            </section>

            <!-- Payment Section -->
            <section id="payment" class="content-section">
                <!-- Payment Tabs Navigation - COMPLETELY SEPARATE -->
                <div class="payment-nav-container">
                    <button class="payment-nav-btn payment-nav-active" data-payment-section="subscriptionInfoSection">
                        Subscription
                    </button>
                    <button class="payment-nav-btn" data-payment-section="plansSection">
                        Plans
                    </button>
                    <button class="payment-nav-btn" data-payment-section="paymentMethodSection">
                        Payment Method
                    </button>
                    <button class="payment-nav-btn" data-payment-section="billingHistorySection">
                        Billing History
                    </button>
                    <div class="payment-nav-underline"></div>
                </div>

                <!-- Subscription Info Subsection -->
                <div id="subscriptionInfoSection" class="profile-subsection active">
                    <div class="profile-info-container">
                        <div class="profile-info-content" id="paymentSection">
                            <!-- Subscription UI will be loaded here by stripe-subscriptions.js -->
                            <div style="text-align: center; padding: 3rem 1rem;">
                                <div class="loading-spinner" style="margin: 0 auto;"></div>
                                <p style="color: var(--color-text-tertiary); margin-top: 1rem;">Loading subscription...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Plans Subsection -->
                <div id="plansSection" class="profile-subsection" style="display: none;">
                    <div class="profile-info-container">
                        <div class="profile-info-content" id="plansContent">
                            <!-- Plans will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Payment Method Subsection -->
                <div id="paymentMethodSection" class="profile-subsection" style="display: none;">
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <div class="profile-field">
                                <div class="profile-field-label">Payment Method</div>
                                <div class="profile-field-value" id="paymentMethodDisplay">
                                    <span style="color: var(--color-text-tertiary);">No payment method on file</span>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Billing Address</div>
                                <div class="profile-field-value" id="billingAddressDisplay">
                                    <span style="color: var(--color-text-tertiary);">Not set</span>
                                </div>
                            </div>
                            <div class="profile-field" style="border-bottom: none;">
                                <div class="profile-field-label">Actions</div>
                                <div class="profile-field-value">
                                    <a href="#" class="plan-action-link" id="managePaymentMethodBtn">
                                        Manage Payment Method
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 4px;">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Billing History Subsection -->
                <div id="billingHistorySection" class="profile-subsection" style="display: none;">
                    <div class="profile-info-container">
                        <div class="profile-info-content" id="billingHistoryContent">
                            <!-- Billing history will be loaded here -->
                            <div style="text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                                <div class="loading-spinner" style="margin: 0 auto;"></div>
                                <p style="color: var(--color-text-tertiary); margin-top: 1rem;">Loading billing history...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                // PAYMENT NAVIGATION - COMPLETELY SEPARATE SYSTEM
                (function() {
                    let updateUnderlineFunction = null;
                    
                    function setupPaymentNav() {
                        const paymentSection = document.getElementById('payment');
                        if (!paymentSection) return;
                        
                        const navContainer = paymentSection.querySelector('.payment-nav-container');
                        const navButtons = paymentSection.querySelectorAll('.payment-nav-btn');
                        const underline = paymentSection.querySelector('.payment-nav-underline');
                        
                        if (!navContainer || !navButtons.length || !underline) {
                            console.log('Payment nav elements not ready');
                            return;
                        }
                        
                        // Check URL for subsection first
                        const urlInfo = typeof parseSectionFromUrl === 'function' ? parseSectionFromUrl() : null;
                        let activeSectionId = null;
                        
                        // If URL has payment subsection, set that as active
                        if (urlInfo && urlInfo.section === 'payment' && urlInfo.subsection) {
                            const subsectionMap = {
                                'subscription': 'subscriptionInfoSection',
                                'plans': 'plansSection',
                                'payment-method': 'paymentMethodSection',
                                'billing': 'billingHistorySection'
                            };
                            activeSectionId = subsectionMap[urlInfo.subsection];
                            console.log('[setupPaymentNav] Setting from URL:', urlInfo.subsection, '->', activeSectionId);
                        }
                        
                        // Check which tab is active and sync content with it
                        let activeBtn = paymentSection.querySelector('.payment-nav-btn.payment-nav-active');
                        
                        // If we have a URL-based section, find and activate that button
                        if (activeSectionId) {
                            navButtons.forEach(function(b) { b.classList.remove('payment-nav-active'); });
                            const targetBtn = Array.from(navButtons).find(b => b.getAttribute('data-payment-section') === activeSectionId);
                            if (targetBtn) {
                                targetBtn.classList.add('payment-nav-active');
                                activeBtn = targetBtn;
                            }
                        }
                        
                        // If no active button, default to subscription
                        if (!activeBtn) {
                            navButtons.forEach(function(b) { b.classList.remove('payment-nav-active'); });
                            navButtons[0].classList.add('payment-nav-active');
                            activeBtn = navButtons[0];
                            activeSectionId = navButtons[0].getAttribute('data-payment-section');
                        } else if (!activeSectionId) {
                            // Get the section ID from the active button
                            activeSectionId = activeBtn.getAttribute('data-payment-section');
                        }
                        
                        // Hide all subsections first
                        paymentSection.querySelectorAll('.profile-subsection').forEach(function(s) {
                            s.style.display = 'none';
                            s.classList.remove('active');
                        });
                        
                        // Show the subsection that matches the active tab
                        const targetSubsection = document.getElementById(activeSectionId);
                        if (targetSubsection) {
                            targetSubsection.style.display = 'block';
                            targetSubsection.classList.add('active');
                        } else {
                            // Fallback to subscription if target not found
                            const subscriptionSection = document.getElementById('subscriptionInfoSection');
                            if (subscriptionSection) {
                                subscriptionSection.style.display = 'block';
                                subscriptionSection.classList.add('active');
                            }
                        }
                        
                        function updateUnderline(btn) {
                            if (!btn || !navContainer || !underline) return;
                            
                            // Use requestAnimationFrame to ensure layout is ready
                            requestAnimationFrame(function() {
                                const btnRect = btn.getBoundingClientRect();
                                const containerRect = navContainer.getBoundingClientRect();
                                
                                if (btnRect.width > 0 && containerRect.width > 0) {
                                    const left = btnRect.left - containerRect.left;
                                    const width = btnRect.width;
                                    
                                    underline.style.left = left + 'px';
                                    underline.style.width = width + 'px';
                                    underline.style.display = 'block';
                                    underline.style.opacity = '1';
                                    underline.style.visibility = 'visible';
                                } else {
                                    // Retry if not ready
                                    setTimeout(function() { updateUnderline(btn); }, 50);
                                }
                            });
                        }
                        
                        // Store function globally so it can be called from search
                        updateUnderlineFunction = updateUnderline;
                        window.updatePaymentUnderline = function(subsectionId) {
                            const btn = paymentSection.querySelector(`.payment-nav-btn[data-payment-section="${subsectionId}"]`);
                            if (btn) {
                                updateUnderline(btn);
                                setTimeout(() => updateUnderline(btn), 50);
                                setTimeout(() => updateUnderline(btn), 150);
                            }
                        };
                        
                        // Position underline immediately
                        const currentActive = paymentSection.querySelector('.payment-nav-btn.payment-nav-active') || navButtons[0];
                        updateUnderline(currentActive);
                        
                        // Also try multiple times to ensure it works
                        setTimeout(function() { updateUnderline(currentActive); }, 50);
                        setTimeout(function() { updateUnderline(currentActive); }, 150);
                        setTimeout(function() { updateUnderline(currentActive); }, 300);
                        
                        // Click handlers
                        navButtons.forEach(function(btn) {
                            btn.onclick = function() {
                                navButtons.forEach(function(b) { b.classList.remove('payment-nav-active'); });
                                this.classList.add('payment-nav-active');
                                updateUnderline(this);
                                
                                const sectionId = this.getAttribute('data-payment-section');
                                paymentSection.querySelectorAll('.profile-subsection').forEach(function(s) {
                                    s.style.display = 'none';
                                    s.classList.remove('active');
                                });
                                
                                const target = document.getElementById(sectionId);
                                if (target) {
                                    target.style.display = 'block';
                                    target.classList.add('active');
                                    
                                    // Update URL with subsection
                                    const subsectionMap = {
                                        'subscriptionInfoSection': 'subscription',
                                        'plansSection': 'plans',
                                        'paymentMethodSection': 'payment-method',
                                        'billingHistorySection': 'billing'
                                    };
                                    const subsectionName = subsectionMap[sectionId];
                                    if (subsectionName && typeof updateUrlForSubsection === 'function') {
                                        updateUrlForSubsection('payment', subsectionName);
                                    }
                                }
                            };
                        });
                    }
                    
                    // Run immediately and multiple times
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', setupPaymentNav);
                    } else {
                        setupPaymentNav();
                    }
                    
                    setTimeout(setupPaymentNav, 100);
                    setTimeout(setupPaymentNav, 300);
                    setTimeout(setupPaymentNav, 600);
                    setTimeout(setupPaymentNav, 1000);
                    
                    // Watch for payment section activation
                    const paymentSection = document.getElementById('payment');
                    if (paymentSection) {
                        // Check if already active on load
                        if (paymentSection.classList.contains('active')) {
                            setTimeout(setupPaymentNav, 50);
                        }
                        
                        const observer = new MutationObserver(function() {
                            if (paymentSection.classList.contains('active')) {
                                setTimeout(setupPaymentNav, 50);
                            }
                        });
                        observer.observe(paymentSection, { attributes: true, attributeFilter: ['class'] });
                    }
                })();
                </script>
            </section>

            <!-- Help Section -->
            <section id="help" class="content-section">
                <div class="help-container">
                    <div class="help-search-wrapper">
                        <div class="help-search-input-wrapper">
                            <svg class="help-search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="M21 21l-4.35-4.35"></path>
                            </svg>
                            <input type="text" class="help-search-field" placeholder="Search for help..." id="helpSearchInput" autocomplete="off">
                            <button class="help-search-clear" id="helpSearchClear" style="display: none;" aria-label="Clear search">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="help-questions">
                        <h2 class="help-questions-title">Common questions</h2>
                        <div class="help-questions-list">
                            <div class="help-question-wrapper">
                                <a href="#" class="help-question" data-question="dashboard-navigation">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I navigate the dashboard?</h3>
                                        <p class="help-question-preview">Learn how to use the sidebar, switch between sections, and find what you need</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Use the sidebar on the left to navigate between sections</li>
                                        <li>Click on Overview, Programs, Progress, or Marketplace to switch areas</li>
                                        <li>The header contains a search bar for quick access</li>
                                        <li>Press "/" to focus the search bar with keyboard shortcuts</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper">
                                <a href="#" class="help-question" data-question="enroll-course">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I enroll in a course?</h3>
                                        <p class="help-question-preview">Step-by-step guide to finding and enrolling in courses from the marketplace</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Go to the Marketplace section from the sidebar</li>
                                        <li>Browse available courses or use the search function</li>
                                        <li>Click on a course to view details</li>
                                        <li>Click "Enroll" or "Get Started" to begin</li>
                                        <li>Enrolled courses appear in your Programs section</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper">
                                <a href="#" class="help-question" data-question="track-progress">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I track my learning progress?</h3>
                                        <p class="help-question-preview">Understanding your progress dashboard, completion rates, and achievements</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>View overall learning statistics in the Progress section</li>
                                        <li>See completion rates for all enrolled courses</li>
                                        <li>Visual progress bars and completion percentages</li>
                                        <li>Filter by time period (week, month, year)</li>
                                        <li>Individual course progress shown in Programs section</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper">
                                <a href="#" class="help-question" data-question="manage-account">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I manage my account settings?</h3>
                                        <p class="help-question-preview">Update your profile, change password, and manage account preferences</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Go to Profile section to update display name, email, and picture</li>
                                        <li>Change password from the Settings section</li>
                                        <li>Manage notification preferences in Settings</li>
                                        <li>Switch between light and dark mode themes</li>
                                        <li>Adjust privacy options from Settings</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="payment-billing">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I update my payment method?</h3>
                                        <p class="help-question-preview">Manage subscriptions, update billing information, and view payment history</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Go to Payment section from the sidebar</li>
                                        <li>Update credit card information securely</li>
                                        <li>Change billing address</li>
                                        <li>View subscription status and payment history</li>
                                        <li>Click "Update Payment Method" to add new cards</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="cancel-subscription">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I cancel my subscription?</h3>
                                        <p class="help-question-preview">Steps to cancel your subscription and understand what happens after cancellation</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Go to the Payment section from the sidebar</li>
                                        <li>Click on "Manage Subscription" or "Subscription Settings"</li>
                                        <li>Select "Cancel Subscription" option</li>
                                        <li>Confirm cancellation when prompted</li>
                                        <li>You'll retain access until the end of your current billing period</li>
                                        <li>No refunds are provided for partial billing periods</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="refund-policy">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">What is your refund policy?</h3>
                                        <p class="help-question-preview">Understanding refund eligibility, processing times, and how to request a refund</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Refunds are available within 30 days of purchase</li>
                                        <li>Course completion over 50% may affect refund eligibility</li>
                                        <li>Contact support to initiate a refund request</li>
                                        <li>Refunds are processed within 5-10 business days</li>
                                        <li>Refunds are issued to the original payment method</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="billing-cycle">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">When will I be charged for my subscription?</h3>
                                        <p class="help-question-preview">Understanding billing cycles, renewal dates, and payment schedules</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Subscriptions are billed monthly or annually based on your plan</li>
                                        <li>You'll be charged on the same date each billing cycle</li>
                                        <li>View your next billing date in the Payment section</li>
                                        <li>You'll receive an email notification before each charge</li>
                                        <li>Failed payments will result in service suspension after 3 attempts</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="access-courses">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I access my enrolled courses?</h3>
                                        <p class="help-question-preview">Find and continue your courses from the Programs section</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>All enrolled courses are in the Programs section</li>
                                        <li>Click "My Programs" in the sidebar to view courses</li>
                                        <li>Filter by category or sort by recent activity</li>
                                        <li>Search for specific courses</li>
                                        <li>Click any course card to continue learning</li>
                                        <li>Progress is automatically saved</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="change-plan">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I change my subscription plan?</h3>
                                        <p class="help-question-preview">Upgrade or downgrade your subscription plan and understand prorated billing</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Go to the Payment section from the sidebar</li>
                                        <li>Click "Change Plan" or "Upgrade/Downgrade"</li>
                                        <li>Select your desired plan and review pricing</li>
                                        <li>Upgrades take effect immediately with prorated charges</li>
                                        <li>Downgrades take effect at the end of your current billing period</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="certificates">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I get my certificates?</h3>
                                        <p class="help-question-preview">Learn about earning and downloading course completion certificates</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Complete all lessons and assessments to earn a certificate</li>
                                        <li>Certificates are automatically issued upon completion</li>
                                        <li>Save courses and materials in the Resources section</li>
                                        <li>Access your saved content anytime</li>
                                        <li>Organize materials for quick reference</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="payment-failed">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">My payment failed. What should I do?</h3>
                                        <p class="help-question-preview">Troubleshooting payment failures and updating payment information</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Check that your payment method has sufficient funds</li>
                                        <li>Verify your card hasn't expired</li>
                                        <li>Update your payment method in the Payment section</li>
                                        <li>Contact your bank if the issue persists</li>
                                        <li>We'll retry payment automatically up to 3 times</li>
                                        <li>Contact support if payment continues to fail</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="reset-password">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I reset my password?</h3>
                                        <p class="help-question-preview">Steps to reset your password if you've forgotten it or want to change it</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Go to the login page and click "Forgot Password"</li>
                                        <li>Enter your email address</li>
                                        <li>Check your email for a password reset link</li>
                                        <li>Click the link and create a new password</li>
                                        <li>Or change your password from Settings if you're logged in</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="delete-account">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I delete my account?</h3>
                                        <p class="help-question-preview">Permanently delete your account and understand what data will be removed</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Go to Settings section from the sidebar</li>
                                        <li>Scroll to "Account" or "Privacy" section</li>
                                        <li>Click "Delete Account" or "Close Account"</li>
                                        <li>Confirm deletion when prompted</li>
                                        <li>All your data will be permanently deleted</li>
                                        <li>This action cannot be undone</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="download-content">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">Can I download course content?</h3>
                                        <p class="help-question-preview">Understanding what content can be downloaded and offline access options</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Some course materials can be downloaded for offline viewing</li>
                                        <li>Look for download icons on individual lessons</li>
                                        <li>PDFs and documents are typically available for download</li>
                                        <li>Video content may have limited offline access</li>
                                        <li>Downloaded content is for personal use only</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="mobile-app">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">Is there a mobile app available?</h3>
                                        <p class="help-question-preview">Information about mobile apps and accessing courses on mobile devices</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Yes, we have mobile apps for iOS and Android</li>
                                        <li>Download from the App Store or Google Play Store</li>
                                        <li>Access all your courses and progress on mobile</li>
                                        <li>Sync your progress across all devices</li>
                                        <li>The mobile app works with your existing account</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="gift-courses">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">Can I gift a course to someone?</h3>
                                        <p class="help-question-preview">How to purchase and send courses as gifts to friends or family</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Yes, you can purchase courses as gifts</li>
                                        <li>Select "Gift this course" when viewing a course</li>
                                        <li>Enter the recipient's email address</li>
                                        <li>Add a personal message if desired</li>
                                        <li>The recipient will receive an email with access instructions</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="course-prerequisites">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">Do courses have prerequisites?</h3>
                                        <p class="help-question-preview">Understanding course requirements and recommended prior knowledge</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Some courses have prerequisites listed in the course description</li>
                                        <li>Check the course details page for requirements</li>
                                        <li>Prerequisites are usually recommended, not required</li>
                                        <li>You can still enroll and learn at your own pace</li>
                                        <li>Instructors provide guidance for beginners when needed</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="technical-issues">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">I'm experiencing technical issues</h3>
                                        <p class="help-question-preview">Troubleshooting common problems and getting technical support</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Refresh the page</li>
                                        <li>Clear your browser cache</li>
                                        <li>Try a different browser</li>
                                        <li>Check your internet connection</li>
                                        <li>If issues persist, contact support with details</li>
                                        <li>Include what you were doing and any error messages</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="video-playback">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">Videos won't play or are buffering</h3>
                                        <p class="help-question-preview">Troubleshooting video playback issues and improving streaming quality</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Check your internet connection speed</li>
                                        <li>Try lowering the video quality in player settings</li>
                                        <li>Close other applications using bandwidth</li>
                                        <li>Clear your browser cache and cookies</li>
                                        <li>Try a different browser or device</li>
                                        <li>Contact support if the issue persists</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="notifications">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I manage notifications?</h3>
                                        <p class="help-question-preview">Control email and push notifications for courses, updates, and reminders</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Go to Settings section from the sidebar</li>
                                        <li>Click on "Notifications" or "Notification Preferences"</li>
                                        <li>Toggle email notifications on or off</li>
                                        <li>Enable or disable push notifications</li>
                                        <li>Customize which types of notifications you receive</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="course-instructor">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How do I contact a course instructor?</h3>
                                        <p class="help-question-preview">Ways to reach out to instructors with questions or feedback</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Instructors often respond to course discussions and Q&A sections</li>
                                        <li>Create notes to track your learning progress</li>
                                        <li>Some courses have direct messaging available</li>
                                        <li>Check the course page for instructor contact information</li>
                                        <li>Response times vary by instructor</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="lifetime-access">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">Do I have lifetime access to courses?</h3>
                                        <p class="help-question-preview">Understanding course access duration and subscription requirements</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Individual course purchases typically include lifetime access</li>
                                        <li>Subscription-based access requires an active subscription</li>
                                        <li>Check the course details for specific access terms</li>
                                        <li>Lifetime access means you can revisit the course anytime</li>
                                        <li>Course updates are included with lifetime access</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="course-updates">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">Will I get updates when courses are updated?</h3>
                                        <p class="help-question-preview">Understanding how course updates work and when you'll be notified</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>Yes, you'll be notified when enrolled courses are updated</li>
                                        <li>Updates are automatically available in your enrolled courses</li>
                                        <li>Check your notifications or email for update announcements</li>
                                        <li>New content is added without additional charges</li>
                                        <li>Your progress is preserved when courses are updated</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-question-wrapper" style="display: none;">
                                <a href="#" class="help-question" data-question="privacy-data">
                                    <div class="help-question-content">
                                        <h3 class="help-question-text">How is my personal data protected?</h3>
                                        <p class="help-question-preview">Understanding our privacy policy and data protection measures</p>
                                    </div>
                                    <svg class="help-question-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </a>
                                <div class="help-question-answer">
                                    <ul>
                                        <li>We use industry-standard encryption to protect your data</li>
                                        <li>Payment information is processed through secure third-party providers</li>
                                        <li>We never share your personal information with third parties</li>
                                        <li>You can review our full privacy policy in Settings</li>
                                        <li>Contact us if you have privacy concerns</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <button class="help-view-more" id="helpViewMore">
                            <span>View More</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                    </div>

                    <div class="help-contact">
                        <div class="help-contact-content">
                            <h3 class="help-contact-title">Still need help?</h3>
                            <p class="help-contact-description">Can't find what you're looking for? Our support team is here to help.</p>
                            
                            <!-- Support Options with Progress Indicator -->
                            <div class="help-support-options-wrapper">
                                <div class="help-support-options-container">
                                    <div class="help-support-options">
                                        <a href="#" class="help-support-option active" data-action="contact">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                                <polyline points="22,6 12,13 2,6"></polyline>
                                            </svg>
                                            <span>Contact Support</span>
                                        </a>
                                        <a href="#" class="help-support-option" data-action="notes">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                            </svg>
                                            <span>My Notes</span>
                                        </a>
                                        <a href="#" class="help-support-option" data-action="tutorials">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                                            </svg>
                                            <span>Video Tutorials</span>
                                        </a>
                                    </div>
                                </div>
                                <div class="help-support-options-line"></div>
                                <div class="help-support-options-indicator" id="helpSupportOptionsIndicator"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Profile Section -->
            <section id="profile" class="content-section">
                <!-- Profile Header Section -->
                <div class="profile-header-section">
                            <div class="profile-picture-wrapper" style="cursor: pointer; position: relative; z-index: 10;">
                                <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" onchange="handleProfilePictureChange(this)">
                                <img id="profilePicture" class="profile-picture" src="" alt="Profile Picture" onclick="var inp = document.getElementById('profilePictureInput'); inp.click();" style="cursor: pointer; z-index: 11; position: relative;">
                                <div class="profile-picture-overlay" onclick="var inp = document.getElementById('profilePictureInput'); inp.click();" style="cursor: pointer; z-index: 12; position: absolute;">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                        <circle cx="12" cy="13" r="4"></circle>
                                    </svg>
                                </div>
                            </div>
                            <div class="profile-info">
                                <h2 class="profile-name" id="profileDisplayName"></h2>
                                <div class="profile-meta">
                                    <div class="profile-email" id="profileEmail"></div>
                                    <div class="profile-member-since" id="profileMemberSince"></div>
                                </div>
                            </div>
                </div>

                <!-- Profile Tabs Navigation -->
                <div class="profile-tabs">
                    <button class="profile-tab active" data-section="personalInfoSection">
                        Personal
                    </button>
                    <button class="profile-tab" data-section="googleAccountSection">
                        Account
                    </button>
                    <button class="profile-tab" data-section="preferencesSection">
                        Preferences
                    </button>
                    <button class="profile-tab" data-section="advancedSection">
                        Advanced
                    </button>
                    <div class="profile-tab-indicator"></div>
                </div>

                <!-- Personal Information Subsection -->
                <div id="personalInfoSection" class="profile-subsection active">
                            <div class="profile-info-container">
                                <div class="profile-info-content">
                                    <div class="profile-field">
                                        <div class="profile-field-label">Name</div>
                                        <div class="profile-field-value" id="profileNameDisplay">
                                            <span id="profileNameText"></span>
                                            <div class="profile-field-inputs" style="display: none;">
                                                <input type="text" class="profile-field-input" id="firstName" placeholder="First name">
                                                <input type="text" class="profile-field-input" id="lastName" placeholder="Last name">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field">
                                        <div class="profile-field-label">Email</div>
                                        <div class="profile-field-value" id="profileEmailDisplay">
                                            <span id="profileEmailText"></span>
                                            <input type="email" class="profile-field-input" id="email" placeholder="your@email.com" readonly style="display: none;">
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field">
                                        <div class="profile-field-label">Password</div>
                                        <div class="profile-field-value" id="profilePasswordDisplay">
                                            <span id="profilePasswordText">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                                            <button class="profile-change-password-btn" id="changePasswordBtn" style="display: none;">Change Password</button>
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field">
                                        <div class="profile-field-label">Contact</div>
                                        <div class="profile-field-value" id="profileContactDisplay">
                                            <span id="profileContactText" style="color: var(--color-text-tertiary);">Not provided</span>
                                            <input type="text" class="profile-field-input" id="contact" placeholder="Phone number or email" style="display: none;">
                                    </div>
                                </div>
                                
                                    <div class="profile-field">
                                        <div class="profile-field-label">Job Title</div>
                                        <div class="profile-field-value" id="profileJobTitleDisplay">
                                            <span id="profileJobTitleText" style="color: var(--color-text-tertiary);">Not provided</span>
                                            <input type="text" class="profile-field-input" id="jobTitle" placeholder="e.g. Software Engineer, Student" style="display: none;">
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field">
                                        <div class="profile-field-label">Location</div>
                                        <div class="profile-field-value" id="profileLocationDisplay">
                                            <span id="profileLocationText" style="color: var(--color-text-tertiary);">Not provided</span>
                                            <input type="text" class="profile-field-input" id="location" placeholder="e.g. New York, USA" style="display: none;">
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field">
                                        <div class="profile-field-label">Website</div>
                                        <div class="profile-field-value" id="profileWebsiteDisplay">
                                            <span id="profileWebsiteText" style="color: var(--color-text-tertiary);">Not provided</span>
                                            <input type="url" class="profile-field-input" id="website" placeholder="https://yourwebsite.com" style="display: none;">
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field profile-field-bio">
                                        <div class="profile-field-label">Bio</div>
                                        <div class="profile-field-value" id="profileBioDisplay">
                                            <span id="profileBioText" style="color: var(--color-text-tertiary);">Add a bio to introduce yourself</span>
                                            <textarea class="profile-field-textarea" id="bio" placeholder="Tell us about yourself" rows="4" style="display: none;"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field profile-field-bio">
                                        <div class="profile-field-label">Learning Goals</div>
                                        <div class="profile-field-value" id="profileGoalsDisplay">
                                            <span id="profileGoalsText" style="color: var(--color-text-tertiary);">What do you want to achieve?</span>
                                            <textarea class="profile-field-textarea" id="learningGoals" placeholder="What are your learning objectives?" rows="3" style="display: none;"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field">
                                        <div class="profile-field-label">Social Links</div>
                                        <div class="profile-field-value" id="profileSocialDisplay" style="flex-direction: column; gap: var(--space-2);">
                                            <div id="profileSocialLogos" class="profile-social-logos" style="display: none; flex-wrap: wrap; gap: var(--space-3);"></div>
                                            <span id="profileSocialText" style="color: var(--color-text-tertiary);">Not provided</span>
                                            <div class="profile-social-inputs" style="display: none; flex-direction: column; gap: var(--space-2);">
                                                <input type="url" class="profile-field-input" id="socialTwitter" placeholder="Twitter/X profile URL" style="display: block;" data-social-type="twitter">
                                                <input type="url" class="profile-field-input" id="socialLinkedIn" placeholder="LinkedIn profile URL" style="display: block;" data-social-type="linkedIn">
                                                <input type="url" class="profile-field-input" id="socialGitHub" placeholder="GitHub profile URL" style="display: block;" data-social-type="github">
                                                <div id="dynamicSocialLinks" style="display: flex; flex-direction: column; gap: var(--space-2);"></div>
                                                <button type="button" id="addSocialBtn" class="add-social-btn" style="display: none;">
                                                    <span>Add Social +</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="profile-edit-controls">
                                    <button class="btn btn-edit-profile" id="profileEditBtn">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                        </svg>
                                    </button>
                                    <div class="profile-edit-actions" id="profileEditActions" style="display: none;">
                                        <button class="btn btn-text-cancel" id="profileCancelBtn">Cancel</button>
                                        <button class="btn btn-primary" id="profileSaveBtn">Save</button>
                                    </div>
                                </div>
                            </div>
                </div>
                
                <!-- Google Account Subsection -->
                <div id="googleAccountSection" class="profile-subsection" style="display: none;">
                            <div class="profile-info-container">
                                <div class="profile-info-content">
                                    <div class="profile-field">
                                        <div class="profile-field-label">Member Since</div>
                                        <div class="profile-field-value">
                                            <span id="memberSinceText">â€”</span>
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field">
                                        <div class="profile-field-label">Account Type</div>
                                        <div class="profile-field-value">
                                            <span id="accountTypeText">Free</span>
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field">
                                        <div class="profile-field-label">Programs Enrolled</div>
                                        <div class="profile-field-value">
                                            <span id="programsEnrolledText">â€”</span>
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field">
                                        <div class="profile-field-label">Sign-In Method</div>
                                        <div class="profile-field-value">
                                            <span id="signInMethodText">â€”</span>
                                        </div>
                                    </div>
                                    
                                    <div class="profile-field">
                                        <div class="profile-field-label">Google Account</div>
                                        <div class="profile-field-value">
                                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                                <span id="googleAccountStatusText" style="color: var(--color-text-tertiary);">Not connected</span>
                                                <button class="btn btn-text-cancel" id="connectGoogleBtn" style="display: none; padding: 0; color: var(--color-brand-purple);">
                                                    Connect
                                                </button>
                                                <button class="btn btn-text-cancel" id="disconnectGoogleBtn" style="display: none; padding: 0; color: var(--color-text-tertiary);">
                                                    Disconnect
                                                </button>
                                            </div>
                                            <div id="googleAccountEmail" style="display: none; margin-top: var(--space-2); color: var(--color-text-secondary); font-size: 13px;"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Set Password for Google Users -->
                                    <div class="profile-field" id="setPasswordField" style="display: none;">
                                        <div class="profile-field-label">Password</div>
                                        <div class="profile-field-value">
                                            <div style="display: flex; align-items: center; gap: var(--space-3); flex-wrap: wrap;">
                                                <span style="color: var(--color-text-tertiary); font-size: 13px;">Set a password to also login with email/password</span>
                                                <button class="btn btn-primary" id="setPasswordBtn" style="padding: var(--space-2) var(--space-4); font-size: 13px;">
                                                    Set Password
                                                </button>
                                            </div>
                                            <div id="setPasswordForm" style="display: none; margin-top: var(--space-4); padding: var(--space-4); background: var(--color-bg-elevated); border-radius: var(--border-radius-md); border: 1px solid var(--color-border-light);">
                                                <div style="margin-bottom: var(--space-3);">
                                                    <label style="display: block; margin-bottom: var(--space-2); font-size: 13px; font-weight: 500; color: var(--color-text-primary);">New Password</label>
                                                    <input type="password" id="newPasswordInput" placeholder="Enter a secure password" style="width: 100%; padding: var(--space-2) var(--space-3); border: 1px solid var(--color-border-light); border-radius: var(--border-radius-sm); background: var(--color-bg-primary); color: var(--color-text-primary); font-size: 14px;">
                                                </div>
                                                <div style="margin-bottom: var(--space-3);">
                                                    <label style="display: block; margin-bottom: var(--space-2); font-size: 13px; font-weight: 500; color: var(--color-text-primary);">Confirm Password</label>
                                                    <input type="password" id="confirmPasswordInput" placeholder="Confirm your password" style="width: 100%; padding: var(--space-2) var(--space-3); border: 1px solid var(--color-border-light); border-radius: var(--border-radius-sm); background: var(--color-bg-primary); color: var(--color-text-primary); font-size: 14px;">
                                                </div>
                                                <div style="display: flex; gap: var(--space-2);">
                                                    <button class="btn btn-primary" id="savePasswordBtn" style="padding: var(--space-2) var(--space-4); font-size: 13px;">Save Password</button>
                                                    <button class="btn btn-text-cancel" id="cancelPasswordBtn" style="padding: var(--space-2) var(--space-4); font-size: 13px;">Cancel</button>
                                                </div>
                                                <div id="passwordError" style="display: none; margin-top: var(--space-2); padding: var(--space-2); background: rgba(239, 68, 68, 0.1); border-radius: var(--border-radius-sm); color: #ef4444; font-size: 12px;"></div>
                                                <div id="passwordSuccess" style="display: none; margin-top: var(--space-2); padding: var(--space-2); background: rgba(34, 197, 94, 0.1); border-radius: var(--border-radius-sm); color: #22c55e; font-size: 12px;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                </div>
                
                <!-- Account Preferences Subsection -->
                <div id="preferencesSection" class="profile-subsection" style="display: none;">
                            <div class="profile-info-container">
                                <div class="profile-info-content">
                                    <div class="profile-field">
                                        <div class="profile-field-label">Email Notifications</div>
                                        <div class="profile-field-value">
                                            <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="emailNotificationsText">Enabled</span>
                                        </div>
                                        <div class="profile-field-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="emailNotificationsToggle" checked onchange="saveSettings()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Marketing Emails</div>
                                        <div class="profile-field-value">
                                            <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="marketingEmailsText">Disabled</span>
                                        </div>
                                        <div class="profile-field-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="marketingEmailsToggle" onchange="saveSettings()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Push Notifications</div>
                                        <div class="profile-field-value">
                                            <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Get browser notifications for important updates</span>
                                        </div>
                                        <div class="profile-field-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="pushNotificationsPref" onchange="saveSettings()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Course Updates</div>
                                        <div class="profile-field-value">
                                            <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Notifications when new content is added to your courses</span>
                                        </div>
                                        <div class="profile-field-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="courseUpdatesPref" onchange="saveSettings()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Assignment Reminders</div>
                                        <div class="profile-field-value">
                                            <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Remind me about upcoming assignments and deadlines</span>
                                        </div>
                                        <div class="profile-field-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="assignmentRemindersPref" onchange="saveSettings()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Study Reminders</div>
                                        <div class="profile-field-value">
                                            <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Daily reminders to keep your learning streak going</span>
                                        </div>
                                        <div class="profile-field-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="studyRemindersPref" onchange="saveSettings()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Animations</div>
                                        <div class="profile-field-value">
                                            <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Enable smooth transitions and animations</span>
                                        </div>
                                        <div class="profile-field-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="animationsPref" onchange="saveSettings()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Compact Sidebar</div>
                                        <div class="profile-field-value">
                                            <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Use a narrower sidebar to save space</span>
                                        </div>
                                        <div class="profile-field-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="compactSidebarPref" onchange="saveSettings()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Auto-play Videos</div>
                                        <div class="profile-field-value">
                                            <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Automatically play course videos when opened</span>
                                        </div>
                                        <div class="profile-field-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="autoPlayVideosPref" onchange="saveSettings()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Progress Tracking</div>
                                        <div class="profile-field-value">
                                            <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Track and display your learning progress</span>
                                        </div>
                                        <div class="profile-field-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="progressTrackingPref" onchange="saveSettings()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Language</div>
                                        <div class="profile-field-value">
                                            <select class="profile-field-input" id="languagePref" style="max-width: 250px; display: block;" onchange="saveLanguagePreference(this.value)">
                                                <option value="en">English</option>
                                                <option value="es">Spanish</option>
                                                <option value="fr">French</option>
                                                <option value="de">German</option>
                                                <option value="ja">Japanese</option>
                                                <option value="zh">Chinese</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="profile-field">
                                        <div class="profile-field-label">Timezone</div>
                                        <div class="profile-field-value">
                                            <select class="profile-field-input" id="timezonePref" style="max-width: 250px; display: block;" onchange="saveTimezonePreference(this.value)">
                                                <option value="UTC">UTC (Coordinated Universal Time)</option>
                                                <option value="America/New_York">Eastern Time (ET)</option>
                                                <option value="America/Chicago">Central Time (CT)</option>
                                                <option value="America/Denver">Mountain Time (MT)</option>
                                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                                <option value="Europe/London">London (GMT)</option>
                                                <option value="Europe/Paris">Paris (CET)</option>
                                                <option value="Asia/Tokyo">Tokyo (JST)</option>
                                                <option value="Asia/Dubai">Dubai (GST)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                </div>
                
                <!-- Advanced Section -->
                <div id="advancedSection" class="profile-subsection" style="display: none;">
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <div class="profile-field">
                                <div class="profile-field-label">Profile Visibility</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="advancedVisibilityText">Public</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="advancedVisibilityToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Two-Factor Authentication</div>
                                <div class="profile-field-value">
                                    <span style="color: var(--color-text-tertiary);">Not enabled</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="advancedTwoFactorToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Show Email Publicly</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="advancedShowEmailText">Hidden</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="advancedShowEmailToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Activity Status</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="advancedActivityStatusText">Visible</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="advancedActivityStatusToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Active Sessions</div>
                                <div class="profile-field-value">
                                    <span style="color: var(--color-text-secondary);">Current device</span>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Timezone</div>
                                <div class="profile-field-value">
                                    <select class="profile-field-input" id="advancedTimezone" style="max-width: 250px;">
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">Eastern Time (ET)</option>
                                        <option value="America/Chicago">Central Time (CT)</option>
                                        <option value="America/Denver">Mountain Time (MT)</option>
                                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                        <option value="Europe/London">London (GMT)</option>
                                        <option value="Europe/Paris">Paris (CET)</option>
                                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                                        <option value="Asia/Shanghai">Shanghai (CST)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Language</div>
                                <div class="profile-field-value">
                                    <select class="profile-field-input" id="advancedLanguage" style="max-width: 200px;">
                                        <option value="en">English</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="de">German</option>
                                        <option value="it">Italian</option>
                                        <option value="pt">Portuguese</option>
                                    </select>
                                </div>
                            </div>
                            <div class="profile-field" style="border-bottom: none;">
                                <div class="profile-field-label">Data Management</div>
                                <div class="profile-field-value" style="flex-direction: column; gap: var(--space-2); align-items: flex-start;">
                                    <a href="#" class="plan-action-link" id="advancedDownloadDataBtn">
                                        Download My Data
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 4px;">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="7 10 12 15 17 10"></polyline>
                                            <line x1="12" y1="15" x2="12" y2="3"></line>
                                        </svg>
                                    </a>
                                    <a href="#" class="plan-action-link" id="advancedDeleteAccountBtn" style="color: var(--color-text-tertiary);">
                                        Delete Account
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 4px;">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Security Section -->
                <div id="securitySection" class="profile-subsection" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Password & Security</h3>
                    </div>
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <div class="profile-field">
                                <div class="profile-field-label">Current Password</div>
                                <div class="profile-field-value">
                                    <span>â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Two-Factor Authentication</div>
                                <div class="profile-field-value">
                                    <span style="color: var(--color-text-tertiary);">Not enabled</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="twoFactorToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Last Password Change</div>
                                <div class="profile-field-value">
                                    <span style="color: var(--color-text-tertiary);">Never</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Privacy Section -->
                <div id="privacySection" class="profile-subsection" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Privacy Settings</h3>
                    </div>
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <div class="profile-field">
                                <div class="profile-field-label">Profile Visibility</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="privacyVisibilityText">Public</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="privacyVisibilityToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Show Email Publicly</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="showEmailText">Hidden</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="showEmailToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Activity Status</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="activityStatusText">Visible</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="activityStatusToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sessions Section -->
                <div id="sessionsSection" class="profile-subsection" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Active Sessions</h3>
                    </div>
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <div class="profile-field">
                                <div class="profile-field-label">Current Session</div>
                                <div class="profile-field-value">
                                    <span style="color: var(--color-text-secondary);">This device</span>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Last Active</div>
                                <div class="profile-field-value">
                                    <span style="color: var(--color-text-secondary);">Just now</span>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Browser</div>
                                <div class="profile-field-value">
                                    <span style="color: var(--color-text-tertiary);">N/A</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Notifications Section -->
                <div id="notificationsSection" class="profile-subsection" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Notification Settings</h3>
                    </div>
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <div class="profile-field">
                                <div class="profile-field-label">Email Notifications</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="notifEmailText">Enabled</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notifEmailToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Push Notifications</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="notifPushText">Enabled</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notifPushToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Course Updates</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="notifCourseText">Enabled</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notifCourseToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Marketing Emails</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="notifMarketingText">Disabled</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notifMarketingToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Appearance Section -->
                <div id="appearanceSection" class="profile-subsection" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Appearance Settings</h3>
                    </div>
                    <div class="profile-info-container">
                        <div class="profile-info-content">
                            <div class="profile-field">
                                <div class="profile-field-label">Theme</div>
                                <div class="profile-field-value">
                                    <select class="profile-field-input" id="themeSelect" style="max-width: 200px;">
                                        <option value="dark">Dark Mode</option>
                                        <option value="light">Light Mode</option>
                                        <option value="auto">Auto (System)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Compact Mode</div>
                                <div class="profile-field-value">
                                    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="compactModeText">Disabled</span>
                                </div>
                                <div class="profile-field-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="compactModeToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-field-label">Font Size</div>
                                <div class="profile-field-value">
                                    <select class="profile-field-input" id="fontSizeSelect" style="max-width: 200px;">
                                        <option value="small">Small</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="large">Large</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                // PROFILE NAVIGATION
                (function() {
                    function setupProfileNav() {
                        const profileSection = document.getElementById('profile');
                        if (!profileSection) return;
                        
                        const profileTabs = profileSection.querySelectorAll('.profile-tab');
                        const profileNavItems = document.querySelectorAll('.profile-nav-item');
                        const tabIndicator = profileSection.querySelector('.profile-tab-indicator');
                        
                        if (!profileTabs.length) {
                            console.log('Profile tabs not ready');
                            return;
                        }
                        
                        // Check URL for subsection first
                        const urlInfo = typeof parseSectionFromUrl === 'function' ? parseSectionFromUrl() : null;
                        let targetSectionId = null;
                        
                        // If URL has profile subsection, set that as active
                        if (urlInfo && urlInfo.section === 'profile' && urlInfo.subsection) {
                            const subsectionMap = {
                                'personal': 'personalInfoSection',
                                'account': 'googleAccountSection',
                                'preferences': 'preferencesSection',
                                'advanced': 'advancedSection'
                            };
                            targetSectionId = subsectionMap[urlInfo.subsection];
                            console.log('[setupProfileNav] Setting from URL:', urlInfo.subsection, '->', targetSectionId);
                            
                            // Activate the correct tab
                            if (targetSectionId) {
                                profileTabs.forEach(tab => tab.classList.remove('active'));
                                const targetTab = Array.from(profileTabs).find(tab => tab.getAttribute('data-section') === targetSectionId);
                                if (targetTab) {
                                    targetTab.classList.add('active');
                                }
                                
                                // Activate the correct nav item
                                profileNavItems.forEach(nav => nav.classList.remove('active'));
                                const targetNav = Array.from(profileNavItems).find(nav => nav.getAttribute('data-section') === targetSectionId);
                                if (targetNav) {
                                    targetNav.classList.add('active');
                                }
                                
                                // Show the correct subsection
                                profileSection.querySelectorAll('.profile-subsection').forEach(s => {
                                    s.style.display = 'none';
                                    s.classList.remove('active');
                                });
                                const targetSubsection = document.getElementById(targetSectionId);
                                if (targetSubsection) {
                                    targetSubsection.style.display = 'block';
                                    targetSubsection.classList.add('active');
                                }
                            }
                        }
                        
                        // Update indicator position
                        function updateIndicator(tab) {
                            if (!tab || !tabIndicator) return;
                            
                            requestAnimationFrame(function() {
                                const tabsContainer = tab.parentElement;
                                const tabRect = tab.getBoundingClientRect();
                                const containerRect = tabsContainer.getBoundingClientRect();
                                
                                if (tabRect.width > 0 && containerRect.width > 0) {
                                    const left = tabRect.left - containerRect.left;
                                    const width = tabRect.width;
                                    
                                    tabIndicator.style.left = left + 'px';
                                    tabIndicator.style.width = width + 'px';
                                }
                            });
                        }
                        
                        // Initialize indicator position
                        const activeTab = profileSection.querySelector('.profile-tab.active') || profileTabs[0];
                        if (activeTab) {
                            updateIndicator(activeTab);
                            setTimeout(() => updateIndicator(activeTab), 50);
                            setTimeout(() => updateIndicator(activeTab), 150);
                        }
                        
                        // Profile tab click handlers
                        profileTabs.forEach(function(tab) {
                            tab.addEventListener('click', function() {
                                const sectionId = this.getAttribute('data-section');
                                if (!sectionId) return;
                                
                                // Update tabs
                                profileTabs.forEach(t => t.classList.remove('active'));
                                this.classList.add('active');
                                updateIndicator(this);
                                
                                // Update nav items
                                profileNavItems.forEach(nav => nav.classList.remove('active'));
                                const matchingNav = Array.from(profileNavItems).find(nav => 
                                    nav.getAttribute('data-section') === sectionId
                                );
                                if (matchingNav) {
                                    matchingNav.classList.add('active');
                                }
                                
                                // Update subsections
                                const subsections = profileSection.querySelectorAll('.profile-subsection');
                                subsections.forEach(s => {
                                    s.style.display = 'none';
                                    s.classList.remove('active');
                                });
                                
                                const targetSection = document.getElementById(sectionId);
                                if (targetSection) {
                                    targetSection.style.display = 'block';
                                    targetSection.classList.add('active');
                                }
                                
                                // Update URL with subsection
                                const subsectionMap = {
                                    'personalInfoSection': 'personal',
                                    'googleAccountSection': 'account',
                                    'preferencesSection': 'preferences',
                                    'advancedSection': 'advanced'
                                };
                                const subsectionName = subsectionMap[sectionId];
                                if (subsectionName && typeof updateUrlForSubsection === 'function') {
                                    updateUrlForSubsection('profile', subsectionName);
                                }
                            });
                        });
                        
                        // Profile nav item click handlers
                        profileNavItems.forEach(function(navItem) {
                            navItem.addEventListener('click', function(e) {
                                e.preventDefault();
                                const sectionId = this.getAttribute('data-section');
                                if (!sectionId) return;
                                
                                // Find corresponding tab and trigger its click
                                const correspondingTab = Array.from(profileTabs).find(tab => 
                                    tab.getAttribute('data-section') === sectionId
                                );
                                if (correspondingTab) {
                                    correspondingTab.click();
                                }
                            });
                        });
                    }
                    
                    // Initialize on load
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', setupProfileNav);
                    } else {
                        setupProfileNav();
                    }
                    
                    // Retry setup multiple times to ensure it works
                    setTimeout(setupProfileNav, 100);
                    setTimeout(setupProfileNav, 300);
                    
                    // Watch for profile section activation
                    const profileSection = document.getElementById('profile');
                    if (profileSection) {
                        const observer = new MutationObserver(function() {
                            if (profileSection.classList.contains('active')) {
                                setTimeout(setupProfileNav, 50);
                            }
                        });
                        observer.observe(profileSection, { attributes: true, attributeFilter: ['class'] });
                    }
                })();
                </script>
            </section>
            
            <!-- Right Side Navigation Panel -->
            <div class="profile-right-panel" id="profileRightPanel">
                <button class="profile-panel-collapse-btn" id="profilePanelToggle" title="Collapse panel">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
                <div class="profile-right-panel-header">
                    <div class="profile-panel-title">
                        <span style="font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.05em;">Profile Settings</span>
                    </div>
                </div>
                <nav class="profile-right-panel-nav">
                    <!-- Account Section -->
                    <div class="profile-panel-section">
                        <div class="profile-section-title">Account</div>
                        <div class="profile-nav-items">
                            <a href="#" class="profile-nav-item active" data-section="personalInfoSection" data-tooltip="Personal Info">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                <span>Personal Info</span>
                            </a>
                            <a href="#" class="profile-nav-item" data-section="googleAccountSection" data-tooltip="Google Account">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                <span>Google Account</span>
                            </a>
                            <a href="#" class="profile-nav-item" data-section="advancedSection" data-tooltip="Advanced">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                                </svg>
                                <span>Advanced</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Security Section -->
                    <div class="profile-panel-section">
                        <div class="profile-section-title">Security</div>
                        <div class="profile-nav-items">
                            <a href="#" class="profile-nav-item" data-section="securitySection" data-tooltip="Password & Security">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                </svg>
                                <span>Password</span>
                            </a>
                            <a href="#" class="profile-nav-item" data-section="privacySection" data-tooltip="Privacy Settings">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                <span>Privacy</span>
                            </a>
                            <a href="#" class="profile-nav-item" data-section="sessionsSection" data-tooltip="Active Sessions">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                    <line x1="8" y1="21" x2="16" y2="21"></line>
                                    <line x1="12" y1="17" x2="12" y2="21"></line>
                                </svg>
                                <span>Sessions</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Preferences Section -->
                    <div class="profile-panel-section">
                        <div class="profile-section-title">Preferences</div>
                        <div class="profile-nav-items">
                            <a href="#" class="profile-nav-item" data-section="preferencesSection" data-tooltip="General Preferences">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                                </svg>
                                <span>General</span>
                            </a>
                            <a href="#" class="profile-nav-item" data-section="notificationsSection" data-tooltip="Notifications">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                </svg>
                                <span>Notifications</span>
                            </a>
                            <a href="#" class="profile-nav-item" data-section="appearanceSection" data-tooltip="Appearance">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="5"></circle>
                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                </svg>
                                <span>Appearance</span>
                            </a>
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <!-- Notifications Section -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Notifications</h3>
                                </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Email Notifications</div>
                                <div class="settings-item-description">Receive email updates about your courses and account</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="emailNotifications" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Push Notifications</div>
                                <div class="settings-item-description">Get browser notifications for important updates</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="pushNotifications" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Course Updates</div>
                                <div class="settings-item-description">Notifications when new content is added to your courses</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="courseUpdates" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Assignment Reminders</div>
                                <div class="settings-item-description">Remind me about upcoming assignments and deadlines</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="assignmentReminders" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Study Reminders</div>
                                <div class="settings-item-description">Daily reminders to keep your learning streak going</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="studyReminders" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Appearance Section -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Appearance</h3>
                            </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Always on Light Mode</div>
                                <div class="settings-item-description">Keep the interface in light mode regardless of system preference</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="alwaysLightMode" onchange="saveThemeToggle()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Animations</div>
                                <div class="settings-item-description">Enable smooth transitions and animations</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="animations" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Compact Sidebar</div>
                                <div class="settings-item-description">Use a narrower sidebar to save space</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="compactSidebar" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Auto-play Videos</div>
                                <div class="settings-item-description">Automatically play course videos when opened</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoPlayVideos" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Privacy Section -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Privacy</h3>
                            </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Profile Visibility</div>
                                <div class="settings-item-description">Allow others to view your profile</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="profileVisibility" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Activity Status</div>
                                <div class="settings-item-description">Show when you're online and active</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="activityStatus" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Data Analytics</div>
                                <div class="settings-item-description">Help improve our service by sharing anonymous usage data</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="dataAnalytics" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Learning Section -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Learning</h3>
                            </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-label">
                                <div class="settings-item-title">Progress Tracking</div>
                                <div class="settings-item-description">Track and display your learning progress</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="progressTracking" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Language</label>
                        <select class="form-select" id="language" onchange="saveLanguagePreference(this.value)">
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="ja">Japanese</option>
                            <option value="zh">Chinese</option>
                        </select>
                        </div>
                    <div class="form-group">
                        <label class="form-label">Timezone</label>
                        <select class="form-select" id="timezone" onchange="saveTimezonePreference(this.value)">
                            <option value="UTC">UTC (Coordinated Universal Time)</option>
                            <option value="America/New_York">Eastern Time (ET)</option>
                            <option value="America/Chicago">Central Time (CT)</option>
                            <option value="America/Denver">Mountain Time (MT)</option>
                            <option value="America/Los_Angeles">Pacific Time (PT)</option>
                            <option value="Europe/London">London (GMT)</option>
                            <option value="Europe/Paris">Paris (CET)</option>
                            <option value="Asia/Tokyo">Tokyo (JST)</option>
                            <option value="Asia/Dubai">Dubai (GST)</option>
                        </select>
                    </div>
                </div>
            </section>
    </main>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="logout-modal">
        <div class="logout-modal-overlay"></div>
        <div class="logout-modal-content">
            <div class="logout-modal-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16,17 21,12 16,7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </div>
            <div class="logout-modal-header">
                <h3 class="logout-modal-title">Sign out of your account?</h3>
            </div>
            <div class="logout-modal-body">
                <p class="logout-modal-message">You'll need to sign in again to access your dashboard and continue learning.</p>
            </div>
            <div class="logout-modal-actions">
                <button class="logout-btn-cancel" id="logoutCancelBtn">Cancel</button>
                <button class="logout-btn-confirm" id="logoutConfirmBtn">Sign out</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="logout-modal" style="display: none;">
        <div class="logout-modal-overlay"></div>
        <div class="logout-modal-content">
            <div class="logout-modal-header">
                <h3 class="logout-modal-title">Change Password</h3>
            </div>
            <div class="logout-modal-body" style="padding: 0 0 var(--space-6) 0;">
                <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                    <div>
                        <label for="currentPassword" style="display: block; font-size: 13px; font-weight: 500; color: var(--color-text-secondary); margin-bottom: var(--space-2);">Current Password</label>
                        <input type="password" id="currentPassword" class="profile-field-input" placeholder="Enter current password" style="width: 100%; display: block;">
                    </div>
                    <div>
                        <label for="newPassword" style="display: block; font-size: 13px; font-weight: 500; color: var(--color-text-secondary); margin-bottom: var(--space-2);">New Password</label>
                        <input type="password" id="newPassword" class="profile-field-input" placeholder="Enter new password" style="width: 100%; display: block;">
                    </div>
                    <div>
                        <label for="confirmPassword" style="display: block; font-size: 13px; font-weight: 500; color: var(--color-text-secondary); margin-bottom: var(--space-2);">Confirm New Password</label>
                        <input type="password" id="confirmPassword" class="profile-field-input" placeholder="Confirm new password" style="width: 100%; display: block;">
                    </div>
                </div>
            </div>
            <div class="logout-modal-actions">
                <button class="logout-btn-cancel" id="changePasswordCancelBtn">Cancel</button>
                <button class="logout-btn-confirm" id="changePasswordConfirmBtn">Change Password</button>
            </div>
        </div>
    </div>

    <!-- Image Cropper Modal -->
    <div id="imageCropperModal" class="image-cropper-modal" style="display: none;">
        <div class="image-cropper-overlay"></div>
        <div class="image-cropper-content">
            <div class="image-cropper-header">
                <h3>Adjust Your Photo</h3>
                <button class="cropper-close-btn" id="cropperCloseBtn">Ã—</button>
            </div>
            <div class="image-cropper-body">
                <div class="cropper-container">
                    <img id="cropperImage" src="" alt="Crop preview">
                </div>
            </div>
            <div class="image-cropper-actions">
                <button class="cropper-btn-cancel" id="cropperCancelBtn">Cancel</button>
                <button class="cropper-btn-upload" id="cropperUploadBtn">Upload Photo</button>
            </div>
        </div>
    </div>

    <!-- Marketplace Filter Drawer -->
    <div id="marketplaceFilterPopup" class="marketplace-filter-drawer">
        <div class="marketplace-filter-overlay"></div>
        <div class="marketplace-filter-panel">
            <div class="marketplace-filter-header">
                <h3 class="marketplace-filter-title">Filters</h3>
                <button class="marketplace-filter-close" id="marketplaceFilterClose">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="marketplace-filter-body">
                <!-- Category Filter -->
                <div class="marketplace-filter-section">
                    <h4 class="marketplace-filter-section-title">Category</h4>
                    <div class="marketplace-filter-options">
                        <button class="marketplace-filter-option active" data-filter-type="category" data-value="all">
                            <span>All</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="category" data-value="ai">
                            <span>AI & Automation</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="category" data-value="business">
                            <span>Business</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="category" data-value="tech">
                            <span>Technology</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="category" data-value="design">
                            <span>Design</span>
                        </button>
                    </div>
                </div>

                <!-- Price Filter -->
                <div class="marketplace-filter-section">
                    <h4 class="marketplace-filter-section-title">Price</h4>
                    <div class="marketplace-filter-options">
                        <button class="marketplace-filter-option active" data-filter-type="price" data-value="all">
                            <span>All Prices</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="price" data-value="free">
                            <span>Free</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="price" data-value="under-50">
                            <span>Under $50</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="price" data-value="50-100">
                            <span>$50 - $100</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="price" data-value="100-200">
                            <span>$100 - $200</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="price" data-value="200-plus">
                            <span>$200+</span>
                        </button>
                    </div>
                </div>

                <!-- Difficulty Filter -->
                <div class="marketplace-filter-section">
                    <h4 class="marketplace-filter-section-title">Difficulty</h4>
                    <div class="marketplace-filter-options">
                        <button class="marketplace-filter-option active" data-filter-type="difficulty" data-value="all">
                            <span>All Levels</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="difficulty" data-value="beginner">
                            <span>Beginner</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="difficulty" data-value="intermediate">
                            <span>Intermediate</span>
                        </button>
                        <button class="marketplace-filter-option" data-filter-type="difficulty" data-value="advanced">
                            <span>Advanced</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="marketplace-filter-footer">
                <button class="marketplace-filter-clear" id="marketplaceFilterClear">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/navigation.js"></script>
    <script src="/js/routing.js"></script>
    <script type="module" src="/js/marketplace.js"></script>
    
    <!-- Help Search Handler -->
    <script>
        (function() {
            const helpInput = document.getElementById('helpSearchInput');
            const helpClearBtn = document.getElementById('helpSearchClear');
            
            if (helpInput && helpClearBtn) {
                helpInput.addEventListener('input', function() {
                    if (this.value) {
                        helpClearBtn.style.display = 'flex';
                    } else {
                        helpClearBtn.style.display = 'none';
                    }
                });
                
                helpClearBtn.addEventListener('click', function() {
                    helpInput.value = '';
                    helpClearBtn.style.display = 'none';
                    helpInput.focus();
                    // Trigger input event
                    const event = new Event('input', { bubbles: true });
                    helpInput.dispatchEvent(event);
                });
            }
        })();
    </script>
    
    <!-- Marketplace Search Autocomplete -->
    <script>
        (function() {
            const marketplaceInput = document.getElementById('marketplaceSearch');
            const marketplaceDropdown = document.getElementById('marketplaceSearchDropdown');
            const marketplaceSuggestions = document.getElementById('marketplaceSearchSuggestions');
            
            if (!marketplaceInput || !marketplaceDropdown || !marketplaceSuggestions) return;
            
            let currentFocus = -1;
            
            marketplaceInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                
                if (!query) {
                    marketplaceDropdown.style.display = 'none';
                    marketplaceSuggestions.innerHTML = '';
                    return;
                }
                
                // Get courses from window.marketplace if available
                const courses = window.marketplace?.courses || [];
                const matches = [];
                
                courses.forEach(course => {
                    const title = (course.title || '').toLowerCase();
                    const category = (course.category || '').toLowerCase();
                    
                    if (title.includes(query) || category.includes(query)) {
                        matches.push({
                            title: course.title,
                            category: course.category,
                            id: course.id
                        });
                    }
                });
                
                if (matches.length > 0) {
                    showMarketplaceSuggestions(matches.slice(0, 6), query);
                } else {
                    marketplaceDropdown.style.display = 'none';
                    marketplaceSuggestions.innerHTML = '';
                }
            });
            
            function showMarketplaceSuggestions(matches, query) {
                const html = matches.map((match, index) => {
                    const highlightedTitle = highlightText(match.title, query);
                    return `
                        <div class="suggestion-item" data-index="${index}" data-course-id="${match.id}">
                            <span class="suggestion-text">${highlightedTitle}</span>
                        </div>
                    `;
                }).join('');
                
                marketplaceSuggestions.innerHTML = html;
                marketplaceDropdown.style.display = 'block';
                
                // Add click handlers
                marketplaceSuggestions.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const courseId = this.dataset.courseId;
                        marketplaceInput.value = this.querySelector('.suggestion-text').textContent;
                        marketplaceDropdown.style.display = 'none';
                        // Trigger search/filter
                        if (window.marketplace && window.marketplace.handleSearch) {
                            window.marketplace.handleSearch(marketplaceInput.value);
                        }
                    });
                });
            }
            
            function highlightText(text, query) {
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<strong>$1</strong>');
            }
            
            // Close dropdown on click outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#marketplaceSearchWrapper')) {
                    marketplaceDropdown.style.display = 'none';
                }
            });
            
            // Keyboard navigation
            marketplaceInput.addEventListener('keydown', function(e) {
                const items = marketplaceSuggestions.querySelectorAll('.suggestion-item');
                
                if (!items.length) return;
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    setActive(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    setActive(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                } else if (e.key === 'Escape') {
                    marketplaceDropdown.style.display = 'none';
                }
            });
            
            function setActive(items) {
                items.forEach((item, index) => {
                    if (index === currentFocus) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
        })();
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, getDocs, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZvKVOLry7oDekiRxZlY_7-u-Nfe15Zts",
            authDomain: "nuerlo-course-platform.firebaseapp.com",
            projectId: "nuerlo-course-platform",
            storageBucket: "nuerlo-course-platform.firebasestorage.app",
            messagingSenderId: "1089335169355",
            appId: "1:1089335169355:web:a327f39b892f5e752398ce",
            measurementId: "G-D6BX96Z7KN"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const analytics = getAnalytics(app);
        
        // Make Firebase available globally
        window.firebase = { auth, db, storage, analytics };
        window.firestoreFunctions = { collection, query, getDocs, doc, getDoc };
    </script>

    <script src="/js/stripe-subscriptions.js"></script>
    
    <!-- Progress Tracking -->
    <script>
        let enrolledCoursesData = [];
        let currentSelectedCourse = null;
        
        async function loadProgressData() {
            try {
                const auth = window.firebase.auth;
                const db = window.firebase.db;
                const { doc, getDoc } = window.firestoreFunctions;
                const user = auth.currentUser;
                
                if (!user) {
                    console.log('No user authenticated');
                    return;
                }
                
                // Get user document to find enrolled courses
                const userRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userRef);
                
                let totalCourses = 0;
                let completedCourses = 0;
                let totalTime = 0;
                let lastActiveDate = null;
                
                enrolledCoursesData = [];
                const activityHTML = [];
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    console.log('User data:', userData);
                    const enrolledCourseIds = userData.enrolledCourses || [];
                    
                    console.log('Enrolled course IDs:', enrolledCourseIds);
                    console.log('Number of enrolled courses:', enrolledCourseIds.length);
                    
                    if (enrolledCourseIds.length === 0) {
                        console.log('No enrolled courses found in user data');
                    }
                    
                    // Fetch each enrolled course from the courses collection
                    for (const courseId of enrolledCourseIds) {
                        console.log('Fetching course:', courseId);
                        try {
                            const courseRef = doc(db, 'courses', courseId);
                            const courseDoc = await getDoc(courseRef);
                            
                            if (courseDoc.exists()) {
                                const courseData = courseDoc.data();
                                courseData.id = courseDoc.id;
                                console.log('Course found:', courseData.title || courseData.name);
                                
                                // Get user's progress for this course from user data
                                const userProgress = userData.courseProgress?.[courseId] || {};
                                
                                // Use real Firebase data for this specific course
                                courseData.progress = userProgress.progress || 0;
                                courseData.timeSpent = userProgress.timeSpent || 0;
                                courseData.modulesCompleted = userProgress.modulesCompleted || 0;
                                courseData.sectionsCompleted = userProgress.sectionsCompleted || 0;
                                courseData.lastAccessed = userProgress.lastAccessed || null;
                                courseData.completed = userProgress.completed || false;
                                courseData.progressHistory = userProgress.progressHistory || null;
                                courseData.startedAt = userProgress.startedAt || null;
                                
                                console.log(`Course "${courseData.title}":`, {
                                    progress: courseData.progress,
                                    timeSpent: courseData.timeSpent,
                                    modulesCompleted: courseData.modulesCompleted,
                                    lastAccessed: courseData.lastAccessed
                                });
                                
                                enrolledCoursesData.push(courseData);
                                totalCourses++;
                            } else {
                                console.log('Course document not found for ID:', courseId);
                                
                                if (courseData.completed) {
                                    completedCourses++;
                                }
                                
                                if (courseData.timeSpent) {
                                    totalTime += courseData.timeSpent || 0;
                                }
                                
                                if (courseData.lastAccessed) {
                                    const accessDate = courseData.lastAccessed.toDate ? courseData.lastAccessed.toDate() : new Date(courseData.lastAccessed);
                                    if (!lastActiveDate || accessDate > lastActiveDate) {
                                        lastActiveDate = accessDate;
                                    }
                                }
                                
                                // Build activity entry
                                const courseName = courseData.title || courseData.courseName || 'Untitled Course';
                                if (courseData.lastAccessed) {
                                    const accessDate = courseData.lastAccessed.toDate ? courseData.lastAccessed.toDate() : new Date(courseData.lastAccessed);
                                    const dateStr = formatDate(accessDate);
                                    activityHTML.push(`
                                        <div class="profile-field">
                                            <div class="profile-field-label">${courseName}</div>
                                            <div class="profile-field-value">
                                                <span style="color: var(--color-text-tertiary);">${dateStr}</span>
                                            </div>
                                        </div>
                                    `);
                                }
                            }
                        } catch (error) {
                            console.error(`Error loading course ${courseId}:`, error);
                        }
                    }
                } else {
                    console.log('User document does not exist');
                }
                
                console.log('Final enrolled courses data:', enrolledCoursesData);
                console.log('Total courses loaded:', totalCourses);
                
                // Update stats
                const enrolledEl = document.getElementById('totalCoursesEnrolled');
                const completedEl = document.getElementById('totalCoursesCompleted');
                
                if (enrolledEl) enrolledEl.textContent = totalCourses;
                if (completedEl) completedEl.textContent = completedCourses;
                
                // Format time
                let timeText = '0 minutes';
                if (totalTime > 0) {
                    if (totalTime >= 60) {
                        const hours = Math.floor(totalTime / 60);
                        const mins = totalTime % 60;
                        timeText = hours > 0 ? `${hours}h ${mins}m` : `${mins} minutes`;
                    } else {
                        timeText = `${totalTime} minutes`;
                    }
                }
                document.getElementById('totalLearningTime').textContent = timeText;
                
                // Calculate streak
                if (lastActiveDate) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    lastActiveDate.setHours(0, 0, 0, 0);
                    const diffDays = Math.floor((today - lastActiveDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        document.getElementById('currentStreak').textContent = '1 day';
                    } else {
                        document.getElementById('currentStreak').textContent = '0 days';
                    }
                    
                    document.getElementById('lastActive').textContent = formatDate(lastActiveDate);
                    document.getElementById('lastActive').style.color = 'var(--color-text-secondary)';
                } else {
                    document.getElementById('currentStreak').textContent = '0 days';
                }
                
                // Populate main course selector
                console.log('About to populate course selector...');
                populateMainCourseSelector();
                
                // Update activity section
                const activityContent = document.getElementById('activityContent');
                if (activityContent) {
                    if (activityHTML.length > 0) {
                        activityContent.innerHTML = activityHTML.join('');
                    } else {
                        activityContent.innerHTML = `
                            <div style="text-align: center; padding: 3rem 1rem; color: var(--color-text-tertiary);">
                                <p style="color: var(--color-text-secondary); margin-bottom: 0.5rem; font-weight: var(--font-weight-medium);">No recent activity</p>
                                <p style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">Your learning activity will appear here</p>
                            </div>
                        `;
                    }
                }
                
                console.log('Progress data loading complete');
                
            } catch (error) {
                console.error('Error loading progress data:', error);
                console.error('Error stack:', error.stack);
            }
        }
        
        function populateMainCourseSelector() {
            const dropdownOptions = document.getElementById('dropdownOptions');
            const noCoursesMsg = document.getElementById('noCoursesMessage');
            if (!dropdownOptions) return;
            
            dropdownOptions.innerHTML = '';
            
            console.log('Populating dropdown with courses:', enrolledCoursesData.length);
            
            if (enrolledCoursesData.length === 0) {
                // Show no courses message
                if (noCoursesMsg) noCoursesMsg.style.display = 'block';
                console.log('No courses to display');
            } else {
                // Hide no courses message
                if (noCoursesMsg) noCoursesMsg.style.display = 'none';
                
                enrolledCoursesData.forEach((course, index) => {
                    const courseName = course.title || course.courseName || course.name || 'Untitled Course';
                    console.log('Adding course to dropdown:', courseName, course);
                    
                    const option = document.createElement('div');
                    option.className = 'custom-dropdown-option';
                    if (index === 0) option.classList.add('selected');
                    option.textContent = courseName;
                    option.dataset.index = index;
                    
                    option.addEventListener('click', () => {
                        selectCourse(index);
                    });
                    
                    dropdownOptions.appendChild(option);
                });
                
                // Auto-select first course
                selectCourse(0);
            }
        }
        
        // Setup custom dropdown toggle
        function setupCustomDropdown() {
            const dropdown = document.getElementById('customDropdown');
            const selected = document.getElementById('dropdownSelected');
            
            if (!dropdown || !selected) return;
            
            selected.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('open');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                dropdown.classList.remove('open');
            });
        }
        
        function selectCourse(index) {
            const courseName = enrolledCoursesData[index]?.title || enrolledCoursesData[index]?.courseName || 'Untitled Course';
            
            // Update selected text
            const selectedText = document.getElementById('selectedCourseText');
            if (selectedText) selectedText.textContent = courseName;
            
            // Update selected class
            const options = document.querySelectorAll('.custom-dropdown-option');
            options.forEach(opt => opt.classList.remove('selected'));
            if (options[index]) options[index].classList.add('selected');
            
            // Close dropdown
            const dropdown = document.getElementById('customDropdown');
            if (dropdown) dropdown.classList.remove('open');
            
            // Update chart
            updateProgressChartForCourse(index);
        }
        
        function updateProgressChartForCourse(index) {
            const course = enrolledCoursesData[parseInt(index)];
            if (!course) {
                console.log('No course found for index:', index);
                return;
            }
            
            currentSelectedCourse = course;
            const progress = course.progress || 0;
            
            console.log('=== Selected Course ===');
            console.log('Course Name:', course.title || course.courseName || course.name);
            console.log('Course ID:', course.id);
            console.log('Progress (from Firebase):', progress + '%');
            console.log('Time Spent (from Firebase):', course.timeSpent, 'minutes');
            console.log('Sections Completed (from Firebase):', course.modulesCompleted || course.sectionsCompleted);
            console.log('Last Accessed (from Firebase):', course.lastAccessed);
            console.log('===================');
            
            // Update progress text
            const progressText = document.getElementById('courseProgressText');
            if (progressText) {
                progressText.textContent = `${Math.round(progress)}% complete`;
            }
            
            // Generate progress history data (uses real Firebase data if available)
            const progressHistory = generateProgressHistory(course);
            drawLineChart(progressHistory);
            
            // Update course details section with Firebase data
            updateCourseDetails(course);
        }
        
        
        function generateProgressHistory(course) {
            const progress = course.progress || 0;
            const history = [];
            const today = new Date();
            
            // Check if course has real progress history data from Firebase
            if (course.progressHistory && Array.isArray(course.progressHistory) && course.progressHistory.length > 0) {
                // Use real Firebase data
                console.log('Using real progress history from Firebase');
                return course.progressHistory.map(entry => ({
                    date: entry.date.toDate ? entry.date.toDate() : new Date(entry.date),
                    progress: entry.progress || 0
                }));
            }
            
            // Otherwise, generate a simple visualization based on current progress
            // Show progress growth over last 30 days
            console.log('Generating progress visualization for current progress:', progress);
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                let dayProgress = 0;
                if (i === 0) {
                    // Today shows current progress
                    dayProgress = progress;
                } else {
                    // Gradual curve leading to current progress
                    const ratio = (30 - i) / 30;
                    dayProgress = progress * ratio;
                }
                
                history.push({
                    date: date,
                    progress: dayProgress
                });
            }
            
            return history;
        }
        
        function drawLineChart(data) {
            const canvas = document.getElementById('progressLineChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            
            if (rect.width === 0 || rect.height === 0) {
                setTimeout(() => drawLineChart(data), 100);
                return;
            }
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            
            const width = rect.width;
            const height = rect.height;
            
            ctx.clearRect(0, 0, width, height);
            
            if (!data || data.length === 0) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.font = '14px system-ui';
                ctx.textAlign = 'center';
                ctx.fillText('Select a course to view progress', width / 2, height / 2);
                return;
            }
            
            const padding = { top: 30, right: 30, bottom: 40, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // Get color
            const purpleColor = getComputedStyle(document.documentElement).getPropertyValue('--color-brand-purple').trim() || '#8B5CF6';
            
            // Draw axes
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, height - padding.bottom);
            ctx.lineTo(width - padding.right, height - padding.bottom);
            ctx.stroke();
            
            // Draw grid lines
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                
                // Y-axis labels
                const value = 100 - (i * 25);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = '11px system-ui';
                ctx.textAlign = 'right';
                ctx.fillText(`${value}%`, padding.left - 10, y + 4);
            }
            
            // Draw line
            ctx.strokeStyle = purpleColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            data.forEach((point, index) => {
                const x = padding.left + (chartWidth / (data.length - 1)) * index;
                const y = padding.top + chartHeight - (point.progress / 100) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw dots
            data.forEach((point, index) => {
                const x = padding.left + (chartWidth / (data.length - 1)) * index;
                const y = padding.top + chartHeight - (point.progress / 100) * chartHeight;
                
                ctx.fillStyle = purpleColor;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Draw X-axis labels (show every 7 days)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.font = '10px system-ui';
            ctx.textAlign = 'center';
            
            for (let i = 0; i < data.length; i += 7) {
                const point = data[i];
                const x = padding.left + (chartWidth / (data.length - 1)) * i;
                const dateStr = `${point.date.getMonth() + 1}/${point.date.getDate()}`;
                ctx.fillText(dateStr, x, height - padding.bottom + 20);
            }
            
            // Store for resize
            window.chartProgressData = data;
            window.drawLineChartGlobal = drawLineChart;
        }
        
        function updateCourseDetails(course) {
            const detailsContent = document.getElementById('courseDetailsContent');
            if (!detailsContent) return;
            
            if (!course) {
                detailsContent.innerHTML = '';
                return;
            }
            
            console.log('Displaying details for course:', course.title || course.name);
            console.log('Firebase data:', {
                timeSpent: course.timeSpent,
                progress: course.progress,
                modulesCompleted: course.modulesCompleted,
                lastAccessed: course.lastAccessed
            });
            
            // Time Spent (from Firebase)
            const timeSpent = course.timeSpent || 0;
            let timeText = '0 minutes';
            if (timeSpent > 0) {
                if (timeSpent >= 60) {
                    const hours = Math.floor(timeSpent / 60);
                    const mins = timeSpent % 60;
                    timeText = hours > 0 ? `${hours}h ${mins}m` : `${mins} minutes`;
                } else {
                    timeText = `${timeSpent} minutes`;
                }
            }
            
            // Progress (from Firebase)
            const progress = course.progress || 0;
            
            // Sections (from Firebase)
            const modulesCompleted = course.modulesCompleted || course.sectionsCompleted || 0;
            const totalModules = course.modules?.length || course.sections?.length || 0;
            
            // Last Accessed (from Firebase)
            const lastAccessed = course.lastAccessed ? (course.lastAccessed.toDate ? course.lastAccessed.toDate() : new Date(course.lastAccessed)) : null;
            
            detailsContent.innerHTML = `
                <div class="profile-field">
                    <div class="profile-field-label">Time Spent</div>
                    <div class="profile-field-value">
                        <span>${timeText}</span>
                    </div>
                </div>
                
                <div class="profile-field">
                    <div class="profile-field-label">Completion</div>
                    <div class="profile-field-value">
                        <span>${Math.round(progress)}%</span>
                    </div>
                </div>
                
                <div class="profile-field">
                    <div class="profile-field-label">Sections Completed</div>
                    <div class="profile-field-value">
                        <span>${modulesCompleted} ${totalModules > 0 ? `/ ${totalModules}` : ''}</span>
                    </div>
                </div>
                
                <div class="profile-field" style="border-bottom: none;">
                    <div class="profile-field-label">Last Accessed</div>
                    <div class="profile-field-value">
                        <span>${lastAccessed ? formatDate(lastAccessed) : 'Not accessed yet'}</span>
                    </div>
                </div>
            `;
        }
        
        function formatDate(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            const options = { month: 'short', day: 'numeric' };
            if (date.getFullYear() !== now.getFullYear()) {
                options.year = 'numeric';
            }
            return date.toLocaleDateString('en-US', options);
        }
        
        // Handle resize
        window.addEventListener('resize', () => {
            if (window.chartProgressData && window.drawLineChartGlobal) {
                drawLineChart(window.chartProgressData);
            }
        });
        
        // Observe when progress section becomes visible
        const progressChartObserver = new MutationObserver(() => {
            const chartSection = document.getElementById('chartSection');
            if (chartSection && chartSection.classList.contains('active')) {
                if (window.chartProgressData && window.drawLineChartGlobal) {
                    setTimeout(() => {
                        drawLineChart(window.chartProgressData);
                    }, 100);
                }
            }
        });
        
        setTimeout(() => {
            const progressSection = document.getElementById('progress');
            if (progressSection) {
                progressChartObserver.observe(progressSection, { attributes: true, attributeFilter: ['class'], subtree: true });
            }
        }, 500);
        
        // Initialize progress data when user is authenticated
        function initProgressTracking() {
            // Setup custom dropdown
            setupCustomDropdown();
            
            if (window.firebase && window.firebase.auth) {
                window.firebase.auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log('User authenticated, loading progress data for:', user.uid);
                        setTimeout(loadProgressData, 1000);
                    } else {
                        console.log('No user authenticated');
                    }
                });
            } else {
                console.log('Firebase not ready, retrying...');
                setTimeout(initProgressTracking, 500);
            }
        }
        
        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initProgressTracking);
        } else {
            initProgressTracking();
        }
    </script>
    
    <script src="/js/dashboard.js"></script>
    <script src="/js/setup-guide.js"></script>
    
    <!-- Fix social logo paths for production -->
    <script>
        // Fix image paths after they're rendered (for obfuscated code with relative paths)
        function fixSocialLogoPaths() {
            const socialLogos = document.querySelectorAll('.social-logo-img');
            socialLogos.forEach(img => {
                let src = img.getAttribute('src') || img.src;
                if (src && src.includes('assets/images/')) {
                    // If path is relative (doesn't start with / or http), make it absolute
                    if (!src.startsWith('/') && !src.startsWith('http')) {
                        img.src = '/' + src.replace(/^\.\//, '');
                    } else if (src.startsWith('assets/images/')) {
                        // Fix paths that should be absolute
                        img.src = '/assets/images/' + src.replace(/^assets\/images\//, '');
                    }
                }
            });
        }
        
        // Run on load and after delays to catch dynamically loaded content
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fixSocialLogoPaths);
        } else {
            fixSocialLogoPaths();
        }
        setTimeout(fixSocialLogoPaths, 500);
        setTimeout(fixSocialLogoPaths, 1000);
        setTimeout(fixSocialLogoPaths, 2000);
        
        // Observe for new social logos being added dynamically
        const observer = new MutationObserver(() => {
            fixSocialLogoPaths();
        });
        
        // Start observing once the container exists
        function startObserving() {
            const socialContainer = document.getElementById('profileSocialLogos');
            if (socialContainer) {
                observer.observe(socialContainer, { childList: true, subtree: true });
            } else {
                setTimeout(startObserving, 500);
            }
        }
        startObserving();
    </script>
    
    <script>
        // Initialize theme immediately to prevent flash
        (function() {
            let themeMode = 'dark'; // Default to dark mode
            
            try {
                // Check for TEMPORARY theme preference (from header toggle) - expires after 24 hours
                const tempTheme = localStorage.getItem('temporaryTheme');
                const tempThemeTimestamp = localStorage.getItem('temporaryThemeTimestamp');
                
                if (tempTheme && tempThemeTimestamp) {
                    const timestamp = parseInt(tempThemeTimestamp);
                    const now = Date.now();
                    const twentyFourHours = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
                    
                    // If temporary theme is still valid (less than 24 hours old)
                    if (now - timestamp < twentyFourHours) {
                        themeMode = tempTheme;
                        console.log('Using temporary theme preference:', tempTheme);
                    } else {
                        // Temporary preference expired, remove it and use permanent setting
                        localStorage.removeItem('temporaryTheme');
                        localStorage.removeItem('temporaryThemeTimestamp');
                        console.log('Temporary theme preference expired, using permanent setting');
                        
                        // Fall through to check permanent settings below
                        const storedSettings = localStorage.getItem('dashboardSettings');
                        if (storedSettings) {
                            const settings = JSON.parse(storedSettings);
                            if (settings.alwaysLightMode) {
                                themeMode = 'light';
                            } else if (settings.themeMode) {
                                themeMode = settings.themeMode;
                            }
                        }
                    }
                } else {
                    // No temporary preference, check PERMANENT settings
                    const storedSettings = localStorage.getItem('dashboardSettings');
                    if (storedSettings) {
                        const settings = JSON.parse(storedSettings);
                        if (settings.alwaysLightMode) {
                            themeMode = 'light';
                        } else if (settings.themeMode) {
                            themeMode = settings.themeMode;
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading theme preferences:', e);
            }
            
            const body = document.body;
            const themeMeta = document.getElementById('themeColorMeta');
            
            if (themeMode === 'light') {
                body.classList.add('light-mode');
                body.setAttribute('data-theme', 'light');
                if (themeMeta) themeMeta.content = '#ffffff';
            } else {
                // Default to dark mode
                body.classList.add('dark-mode');
                body.setAttribute('data-theme', 'dark');
                if (themeMeta) themeMeta.content = '#0a0a0a';
            }
        })();
    </script>
    
    <script>
        // Helper function to refresh user name in header
        async function refreshUserNameInHeader() {
            const userName = document.getElementById('userName');
            if (!userName) return;
            
            // Use cached value immediately if available
            const cachedFirstName = window.cachedUserFirstName || 'Student';
            const currentSection = document.querySelector('.content-section.active');
            const isOverview = currentSection && currentSection.id === 'overview';
            
            if (isOverview && cachedFirstName) {
                userName.textContent = cachedFirstName;
                userName.style.display = 'inline';
            }
            
            // Then update from Firestore in background and update cache
            try {
                const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const auth = getAuth();
                const user = auth.currentUser;
                
                if (user && window.firebase?.db) {
                    const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const userDocRef = doc(window.firebase.db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        let firstName = 'Student';
                        
                        // Prioritize firstName from Firestore
                        if (userData.firstName) {
                            firstName = userData.firstName.trim();
                        } else if (userData.displayName) {
                            firstName = userData.displayName.split(' ')[0].trim() || 'Student';
                        }
                        
                        if (!firstName || firstName === 'User' || firstName === '' || firstName.toLowerCase() === 'user') {
                            firstName = 'Student';
                        }
                        
                        // Update cache
                        window.cachedUserFirstName = firstName;
                        
                        // Update display if still on overview
                        if (isOverview) {
                            userName.textContent = firstName;
                            userName.style.display = 'inline';
                            console.log('Header user name refreshed:', firstName);
                        } else {
                            userName.style.display = 'none';
                            userName.textContent = '';
                        }
                    }
                }
            } catch (error) {
                console.error('Error refreshing user name:', error);
            }
        }
        
        // Navigation functionality
        // This function handles section navigation AND URL updates
        // Updated to support subsections in URL: e.g., /programs/notstarted
        function navigateToSection(sectionName, subsectionName = null) {
            // If leaving profile section and there are unsaved changes, discard them
            const currentSection = document.querySelector('.content-section.active');
            if (currentSection && currentSection.id === 'profile') {
                // Exit edit mode if active
                if (typeof exitProfileEditMode === 'function') {
                    exitProfileEditMode();
                }
                if (typeof hasUnsavedChanges === 'function' && hasUnsavedChanges()) {
                    // Discard changes silently when navigating away
                    if (typeof cancelProfileChanges === 'function') {
                        cancelProfileChanges();
                    }
                }
            }
            
            // Determine subsection BEFORE showing section - check localStorage or use default
            if (!subsectionName) {
                const defaultSubsections = {
                    'profile': 'personal',
                    'programs': 'all',
                    'progress': 'progress',
                    'payment': 'subscription'
                };
                
                // First, try to get the last visited subsection for this section from localStorage
                const lastSubsection = localStorage.getItem('lastDashboardSubsection_' + sectionName);
                
                if (lastSubsection) {
                    // Use the last visited subsection
                    subsectionName = lastSubsection;
                    console.log('[Navigation] Restoring last subsection for', sectionName, ':', lastSubsection);
                } else if (defaultSubsections[sectionName]) {
                    // Fall back to default if no saved subsection
                    subsectionName = defaultSubsections[sectionName];
                    console.log('[Navigation] Using default subsection for', sectionName, ':', subsectionName);
                }
            }
            
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Handle subsection navigation if provided (determined above)
                if (subsectionName) {
                    setTimeout(() => {
                        navigateToSubsection(sectionName, subsectionName);
                    }, 50);
                }
            }
            
            // Load recommended courses when overview section is shown
            if (sectionName === 'overview') {
                setTimeout(() => {
                    // Clear recommendedGrid first to prevent any other renderer from interfering
                    const recommendedGrid = document.getElementById('recommendedGrid');
                    if (recommendedGrid) {
                        recommendedGrid.innerHTML = '';
                    }
                    
                    if (typeof loadRecommendedCourses === 'function') {
                        loadRecommendedCourses();
                    } else if (window.marketplace && typeof window.marketplace.renderCourses === 'function') {
                        window.marketplace.renderCourses('recommendedGrid');
                    }
                }, 200);
            }
            
            // Show/hide profile right panel
            const profileRightPanel = document.getElementById('profileRightPanel');
            const profileSection = document.getElementById('profile');
            if (profileRightPanel && profileSection) {
                if (sectionName === 'profile') {
                    profileRightPanel.style.display = 'flex';
                    // Set margin based on collapse state
                    const isCollapsed = profileRightPanel.classList.contains('collapsed');
                    const sidebarWidth = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
                    const collapsedWidth = '64px';
                    profileSection.style.marginRight = isCollapsed ? collapsedWidth : sidebarWidth;
                } else {
                    profileRightPanel.style.display = 'none';
                    profileSection.style.marginRight = '0';
                }
            }
            
            // Hide auto-save prompt if not in profile section
            if (sectionName !== 'profile') {
                if (typeof hideAutoSavePrompt === 'function') {
                    hideAutoSavePrompt();
                }
            }
            
            // Load social links when navigating to profile section
            if (sectionName === 'profile' && typeof loadSocialLinks === 'function') {
                loadSocialLinks();
            }
            
            // Update nav items
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.parentElement.classList.remove('active');
                if (link.getAttribute('data-section') === sectionName) {
                    link.parentElement.classList.add('active');
                }
            });
            
            // Update header title - use the updateHeaderTitle function if available
            // CRITICAL: If on payment section, always keep title as "Payment"
            const paymentSection = document.getElementById('payment');
            const isOnPaymentSection = (paymentSection && paymentSection.classList.contains('active')) || 
                                       sectionName === 'payment';
            
            if (typeof updateHeaderTitle === 'function') {
                // Use the centralized function which has protection for payment section
                if (isOnPaymentSection) {
                    updateHeaderTitle('payment');
                } else {
                    updateHeaderTitle(sectionName);
                }
            } else {
                // Fallback: direct update (shouldn't happen if dashboard.js is loaded)
                const titles = {
                    'overview': 'Overview',
                    'programs': 'My Programs',
                    'progress': 'Progress',
                    'resources': 'Resources',
                    'marketplace': 'Marketplace',
                    'tasks': 'Tasks',
                    'notes': 'Notes',
                    'payment': 'Payment',
                    'subscriptions': 'Payment',
                    'help': 'Help',
                    'profile': 'Profile',
                    'settings': 'Settings'
                };
                
                const titleText = document.getElementById('titleText');
                const userName = document.getElementById('userName');
                
                // If on payment section, force title to "Payment"
                const finalSectionName = isOnPaymentSection ? 'payment' : sectionName;
                
                if (titleText && titles[finalSectionName]) {
                    if (finalSectionName === 'overview') {
                        // Always show "Welcome, [FirstName]" when on overview section
                            titleText.textContent = 'Welcome, ';
                            if (userName) {
                            // Use cached first name immediately (no delay)
                            const cachedFirstName = window.cachedUserFirstName || 'Student';
                            userName.textContent = cachedFirstName;
                                userName.style.display = 'inline';
                            // Refresh the user name in background to ensure it's up to date
                                refreshUserNameInHeader();
                        }
                    } else {
                        // For all other sections, set just the section title and hide/clear userName
                        titleText.textContent = titles[finalSectionName];
                        if (userName) {
                            userName.style.display = 'none';
                            userName.textContent = ''; // Clear the text content to prevent any display issues
                        }
                    }
                }
            }
            
            // Update URL with section and subsection (use helper functions from dashboard.js if available)
            if (window.history && window.history.pushState) {
                let newUrl = null;
                
                // Try to use buildDashboardUrlWithSection from dashboard.js if available
                if (typeof window.buildDashboardUrlWithSection === 'function') {
                    newUrl = window.buildDashboardUrlWithSection(sectionName);
                } else {
                    // Fallback: build URL manually
                    const pathname = window.location.pathname;
                    const isLocalDev = window.location.hostname === 'localhost' || 
                                     window.location.hostname === '127.0.0.1' ||
                                     window.location.hostname === '0.0.0.0' ||
                                     window.location.hostname === '';
                    
                    const hasAccountPrefix = pathname.match(/^\/acct_/);
                    
                    if (hasAccountPrefix && !isLocalDev) {
                        const accountMatch = pathname.match(/^(\/acct_[^\/]+)/);
                        const accountPrefix = accountMatch ? accountMatch[1] : '';
                        if (sectionName === 'overview') {
                            newUrl = `${accountPrefix}/overview`;
                        } else {
                            newUrl = `${accountPrefix}/${sectionName}`;
                            // Add subsection to URL if provided
                            if (subsectionName) {
                                newUrl += '/' + subsectionName;
                            }
                        }
                    } else {
                        if (sectionName === 'overview') {
                            newUrl = '/overview';
                        } else {
                            newUrl = '/' + sectionName;
                            // Add subsection to URL if provided
                            if (subsectionName) {
                                newUrl += '/' + subsectionName;
                            }
                        }
                    }
                }
                
                if (newUrl && newUrl !== window.location.pathname) {
                    window.history.pushState({ section: sectionName, subsection: subsectionName }, '', newUrl);
                    console.log('URL updated to:', newUrl);
                }
                
                // Save to localStorage
                if (typeof localStorage !== 'undefined') {
                    localStorage.setItem('lastDashboardSection', sectionName);
                    if (subsectionName) {
                        localStorage.setItem('lastDashboardSubsection_' + sectionName, subsectionName);
                    }
                }
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Helper function to navigate to a specific subsection within a section
        function navigateToSubsection(sectionName, subsectionName) {
            console.log('Navigating to subsection:', sectionName, subsectionName);
            
            // Map subsection URL names to actual element IDs
            const subsectionMap = {
                'programs': {
                    'all': 'allProgramsSection',
                    'not-started': 'notStartedSection',
                    'in-progress': 'inProgressSection',
                    'completed': 'completedSection'
                },
                'progress': {
                    'chart': 'chartSection',
                    'progress': 'chartSection',
                    'stats': 'statsSection',
                    'activity': 'activitySection'
                },
                'profile': {
                    'personal': 'profileInfo',
                    'account': 'profileSecurity',
                    'preferences': 'profileNotifications',
                    'advanced': 'profilePrivacy'
                },
                'settings': {
                    'general': 'generalSettings',
                    'appearance': 'appearanceSettings',
                    'notifications': 'notificationSettings',
                    'privacy': 'privacySettings'
                },
                'payment': {
                    'subscription': 'subscriptionInfoSection',
                    'plans': 'plansSection',
                    'payment-method': 'paymentMethodSection',
                    'billing': 'billingHistorySection'
                }
            };
            
            const subsectionId = subsectionMap[sectionName]?.[subsectionName.toLowerCase()];
            
            if (!subsectionId) {
                console.warn('Unknown subsection:', subsectionName, 'for section:', sectionName);
                return;
            }
            
            // Handle different section types with their specific navigation systems
            if (sectionName === 'programs') {
                // Programs section uses payment-nav-btn buttons
                const navButtons = document.querySelectorAll('.payment-nav-btn');
                navButtons.forEach(btn => {
                    btn.classList.remove('payment-nav-active');
                    if (btn.getAttribute('data-programs-section') === subsectionId) {
                        btn.classList.add('payment-nav-active');
                        btn.click(); // Trigger the click to handle all the UI updates
                    }
                });
            } else if (sectionName === 'progress') {
                // Progress section uses progress-nav-btn buttons
                const navButtons = document.querySelectorAll('.progress-nav-btn');
                navButtons.forEach(btn => {
                    btn.classList.remove('progress-nav-active');
                    if (btn.getAttribute('data-progress-section') === subsectionId) {
                        btn.classList.add('progress-nav-active');
                        btn.click(); // Trigger the click to handle all the UI updates
                    }
                });
            } else if (sectionName === 'profile') {
                // Profile section uses profile-nav-item elements
                if (typeof navigateToProfileSubsection === 'function') {
                    navigateToProfileSubsection(subsectionId);
                }
            } else if (sectionName === 'payment') {
                // Payment section uses payment-nav-btn buttons
                const navButtons = document.querySelectorAll('#payment .payment-nav-btn');
                navButtons.forEach(btn => {
                    btn.classList.remove('payment-nav-active');
                    if (btn.getAttribute('data-payment-section') === subsectionId) {
                        btn.classList.add('payment-nav-active');
                        btn.click(); // Trigger the click to handle all the UI updates
                    }
                });
            }
            
            // Update URL without triggering navigation
            updateUrlForSubsection(sectionName, subsectionName);
        }
        
        // Helper function to update URL for subsection without triggering navigation
        function updateUrlForSubsection(sectionName, subsectionName) {
            if (!window.history || !window.history.pushState) return;
            
            const pathname = window.location.pathname;
            const isLocalDev = window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1' ||
                             window.location.hostname === '0.0.0.0' ||
                             window.location.hostname === '';
            
            const hasAccountPrefix = pathname.match(/^\/acct_/);
            let newUrl = null;
            
            if (hasAccountPrefix && !isLocalDev) {
                const accountMatch = pathname.match(/^(\/acct_[^\/]+)/);
                const accountPrefix = accountMatch ? accountMatch[1] : '';
                newUrl = `${accountPrefix}/${sectionName}/${subsectionName}`;
            } else {
                newUrl = `/${sectionName}/${subsectionName}`;
            }
            
            if (newUrl && newUrl !== window.location.pathname) {
                window.history.pushState({ section: sectionName, subsection: subsectionName }, '', newUrl);
                console.log('URL updated to:', newUrl);
            }
            
            // Save the current subsection to localStorage for this section
            // So when user returns to this section, we can restore their last position
            localStorage.setItem('lastDashboardSubsection_' + sectionName, subsectionName);
            console.log('[Memory] Saved last subsection for', sectionName, ':', subsectionName);
        }
        
        // Helper function to parse URL and extract section and subsection
        function parseSectionFromUrl() {
            const pathname = window.location.pathname;
            
            // Remove account prefix if present: /acct_xxx/section/subsection -> /section/subsection
            const cleanPath = pathname.replace(/^\/acct_[^\/]+/, '');
            
            // Split path into segments
            const segments = cleanPath.split('/').filter(s => s);
            
            if (segments.length === 0) {
                return { section: 'overview', subsection: null };
            }
            
            const section = segments[0];
            const subsection = segments[1] || null;
            
            return { section, subsection };
        }

        // Sidebar toggle for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // Sidebar collapse/expand toggle
        function toggleSidebarCollapse() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const isCollapsed = sidebar.classList.toggle('collapsed');
            
            // Update button title
            sidebarToggle.title = isCollapsed ? 'Expand sidebar' : 'Collapse sidebar';
            
            // Save state to localStorage in both formats for compatibility
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            
            // Also save to unified dashboardSettings
            try {
                const storedSettings = localStorage.getItem('dashboardSettings');
                const settings = storedSettings ? JSON.parse(storedSettings) : {};
                settings.compactSidebar = isCollapsed;
                localStorage.setItem('dashboardSettings', JSON.stringify(settings));
            } catch (error) {
                console.error('Error saving sidebar state:', error);
            }
            
            // Also update the main element if it exists
            const main = document.querySelector('.dashboard-main');
            if (main) {
                if (isCollapsed) {
                    main.classList.add('sidebar-collapsed');
                } else {
                    main.classList.remove('sidebar-collapsed');
                }
            }
        }

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeMeta = document.getElementById('themeColorMeta');
            const sunIcon = document.querySelector('.theme-icon-sun');
            const moonIcon = document.querySelector('.theme-icon-moon');
            const isDark = body.classList.contains('dark-mode') || (!body.classList.contains('light-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            let newThemeMode;
            if (isDark) {
                // Switch to light mode
                newThemeMode = 'light';
            } else {
                // Switch to dark mode
                newThemeMode = 'dark';
            }
            
            // Apply theme and save as TEMPORARY preference (24 hours)
            applyThemeMode(newThemeMode);
            
            // Save temporary theme with timestamp
            localStorage.setItem('temporaryTheme', newThemeMode);
            localStorage.setItem('temporaryThemeTimestamp', Date.now().toString());
            console.log('Temporary theme saved:', newThemeMode, 'Expires in 24 hours');
        }
        
        // Helper function to apply theme (also used by saveThemePreference)
        function applyThemeMode(themeMode) {
            const body = document.body;
            const themeMeta = document.getElementById('themeColorMeta');
            const sunIcon = document.querySelector('.theme-icon-sun');
            const moonIcon = document.querySelector('.theme-icon-moon');
            
            // Add transitioning class to enable smooth transitions
            body.classList.add('theme-transitioning');
            
            // Apply all changes simultaneously
            if (themeMode === 'light') {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                body.setAttribute('data-theme', 'light');
                if (themeMeta) themeMeta.content = '#ffffff';
                if (sunIcon) sunIcon.setAttribute('stroke', '#171717');
                if (moonIcon) moonIcon.setAttribute('stroke', '#171717');
            } else if (themeMode === 'dark') {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                body.setAttribute('data-theme', 'dark');
                if (themeMeta) themeMeta.content = '#0a0a0a';
                if (sunIcon) sunIcon.setAttribute('stroke', '#fafafa');
                if (moonIcon) moonIcon.setAttribute('stroke', '#fafafa');
            }
            
            // Remove transitioning class after transition completes
            setTimeout(() => {
                body.classList.remove('theme-transitioning');
            }, 250);
            
            // Dispatch custom event so other pages can update theme in same tab
            window.dispatchEvent(new CustomEvent('themeChanged', { detail: { themeMode } }));
        }
        
        // Expose functions globally
        window.toggleTheme = toggleTheme;
        window.applyThemeMode = applyThemeMode;
        window.navigateToSection = navigateToSection;
        window.navigateToSubsection = navigateToSubsection;
        window.updateUrlForSubsection = updateUrlForSubsection;
        window.parseSectionFromUrl = parseSectionFromUrl;

        // Update icon colors based on current theme
        function updateThemeIconColors() {
            const sunIcon = document.querySelector('.theme-icon-sun');
            const moonIcon = document.querySelector('.theme-icon-moon');
            const body = document.body;
            
            if (body.classList.contains('dark-mode')) {
                if (sunIcon) sunIcon.setAttribute('stroke', '#fafafa');
                if (moonIcon) moonIcon.setAttribute('stroke', '#fafafa');
                        } else {
                if (sunIcon) sunIcon.setAttribute('stroke', '#171717');
                if (moonIcon) moonIcon.setAttribute('stroke', '#171717');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Update icon colors after DOM is ready
            updateThemeIconColors();
            
            // Theme toggle button
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    toggleTheme();
                    // Update icon colors after toggle
                    setTimeout(updateThemeIconColors, 10);
                });
            }

            // Initialize sidebar collapse state from localStorage
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            // Check both legacy sidebarCollapsed and new compactSidebar setting
            let shouldCollapse = false;
            try {
                const legacyState = localStorage.getItem('sidebarCollapsed');
                const storedSettings = localStorage.getItem('dashboardSettings');
                
                if (storedSettings) {
                    const settings = JSON.parse(storedSettings);
                    if (settings.compactSidebar !== undefined) {
                        shouldCollapse = settings.compactSidebar;
                    } else if (legacyState === 'true') {
                        shouldCollapse = true;
                    }
                } else if (legacyState === 'true') {
                    shouldCollapse = true;
                }
            } catch (error) {
                console.error('Error loading sidebar state:', error);
            }
            
            if (shouldCollapse && sidebar) {
                sidebar.classList.add('collapsed');
                const main = document.querySelector('.dashboard-main');
                if (main) {
                    main.classList.add('sidebar-collapsed');
                }
                if (sidebarToggle) {
                    sidebarToggle.title = 'Expand sidebar';
                }
            }
            
            // Add click handler for collapse button
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebarCollapse);
            }

            // Navigation click handlers
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    if (section) {
                        navigateToSection(section);
                    }
                });
            });

            // Filter categories - click handlers (purple line handled by CSS ::after)
            const filterCategories = document.querySelectorAll('.filter-category');
            filterCategories.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterCategories.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Parse URL and navigate to section/subsection on page load
            // Wait for Firebase, routing.js, and all navigation systems to be ready
            setTimeout(() => {
                const urlInfo = parseSectionFromUrl();
                console.log('[Dashboard Init] Parsed URL on load:', urlInfo);
                
                if (urlInfo.section && urlInfo.section !== 'overview') {
                    // Navigate to the section first
                    console.log('[Dashboard Init] Navigating to section:', urlInfo.section, 'subsection:', urlInfo.subsection);
                    navigateToSection(urlInfo.section, urlInfo.subsection);
                    
                    // If there's a subsection, ensure it gets activated after section is loaded
                    if (urlInfo.subsection) {
                        // Add extra delay to ensure section navigation is complete
                        setTimeout(() => {
                            console.log('[Dashboard Init] Ensuring subsection is active:', urlInfo.subsection);
                            navigateToSubsection(urlInfo.section, urlInfo.subsection);
                        }, 500);
                    }
                } else if (urlInfo.subsection) {
                    // If we have a subsection but section is overview, treat first segment as section
                    navigateToSection(urlInfo.subsection, null);
                }
            }, 500);

            // Loading screen is handled by dashboard.js during authentication
        });

        // Logout handler - uses the one from dashboard.js
        // This function is defined in dashboard.js and will be called

        // Resume course functionality
        function resumeCourse() {
            const continueCourse = document.getElementById('continueCourse');
            if (continueCourse && continueCourse.style.display !== 'none') {
                const courseId = continueCourse.getAttribute('data-course-id');
                if (courseId) {
                    // Store courseId in sessionStorage for CourseRouter to detect course context
                    sessionStorage.setItem('currentCourseId', courseId);
                    // Navigate to course with courseId in URL: /{courseId}/details
                    window.location.href = `/${courseId}/details`;
                }
            }
        }

        // Toggle filters drawer
        function toggleFilters() {
            const drawer = document.getElementById('marketplaceFilterPopup');
            if (drawer) {
                const isOpening = !drawer.classList.contains('active');
                drawer.classList.toggle('active');
                
                if (drawer.classList.contains('active')) {
                    document.body.style.overflow = 'hidden';
                    
                    // Sync filter states when opening
                    if (isOpening && window.marketplace) {
                        const currentFilters = window.marketplace.currentFilters || {
                            category: 'all',
                            price: 'all',
                            difficulty: 'all'
                        };
                        
                        const filterOptions = drawer.querySelectorAll('.marketplace-filter-option');
                        filterOptions.forEach(option => {
                            const filterType = option.getAttribute('data-filter-type');
                            const value = option.getAttribute('data-value');
                            
                            if (currentFilters[filterType] === value) {
                                option.classList.add('active');
                            } else {
                                option.classList.remove('active');
                            }
                        });
                    }
                } else {
                    document.body.style.overflow = '';
                }
            }
        }

        // Initialize marketplace filter drawer
        function initMarketplaceFilterPopup() {
            const drawer = document.getElementById('marketplaceFilterPopup');
            const closeBtn = document.getElementById('marketplaceFilterClose');
            const overlay = drawer?.querySelector('.marketplace-filter-overlay');
            const clearBtn = document.getElementById('marketplaceFilterClear');
            const filterOptions = drawer?.querySelectorAll('.marketplace-filter-option');

            if (!drawer) return;

            // Close drawer
            function closeDrawer() {
                drawer.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Close button
            if (closeBtn) {
                closeBtn.addEventListener('click', closeDrawer);
            }

            // Overlay click
            if (overlay) {
                overlay.addEventListener('click', closeDrawer);
            }

            // Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && drawer.classList.contains('active')) {
                    closeDrawer();
                }
            });

            // Filter option clicks - Apply filters in real-time
            if (filterOptions) {
                filterOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        const filterType = this.getAttribute('data-filter-type');
                        const value = this.getAttribute('data-value');
                        
                        // Remove active from siblings of same type
                        const siblings = drawer.querySelectorAll(`[data-filter-type="${filterType}"]`);
                        siblings.forEach(sibling => sibling.classList.remove('active'));
                        
                        // Add active to clicked option
                        this.classList.add('active');

                        // Apply filters immediately
                        if (window.marketplace) {
                            const selectedFilters = {
                                category: 'all',
                                price: 'all',
                                difficulty: 'all'
                            };

                            filterOptions.forEach(opt => {
                                if (opt.classList.contains('active')) {
                                    const type = opt.getAttribute('data-filter-type');
                                    const val = opt.getAttribute('data-value');
                                    selectedFilters[type] = val;
                                }
                            });

                            window.marketplace.currentFilters = selectedFilters;
                            window.marketplace.applyFilters();
                        }
                    });
                });
            }

            // Clear all filters
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    if (filterOptions) {
                        filterOptions.forEach(option => {
                            const value = option.getAttribute('data-value');
                            if (value === 'all') {
                                option.classList.add('active');
                            } else {
                                option.classList.remove('active');
                            }
                        });

                        // Apply cleared filters
                        if (window.marketplace) {
                            window.marketplace.currentFilters = {
                                category: 'all',
                                price: 'all',
                                difficulty: 'all'
                            };
                            window.marketplace.applyFilters();
                        }
                    }
                });
            }
        }

        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMarketplaceFilterPopup);
        } else {
            initMarketplaceFilterPopup();
        }

        // Load user information from Firebase
        window.loadUserInfo = async function loadUserInfo() {
            try {
                if (!window.firebase || !window.firebase.auth || !window.firebase.db) {
                    console.log('Firebase not ready yet');
                    setTimeout(loadUserInfo, 100);
                    return;
                }

                const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const { doc, getDoc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                const auth = getAuth();
                const user = auth.currentUser;
                
                if (!user) {
                    console.log('No user logged in');
                    return;
                }

                console.log('Loading user info for:', user.uid, user.email);

                // Get user data from Firestore
                let displayName = user.displayName || user.email?.split('@')[0] || 'User';
                let photoURL = user.photoURL || null;
                let userData = null; // Declare userData in outer scope
                
                try {
                    const userDocRef = doc(window.firebase.db, 'users', user.uid);
                    let userDoc = await getDoc(userDocRef);
                    
                    // Create user document if it doesn't exist
                    if (!userDoc.exists()) {
                        console.log('User document not found in loadUserInfo, creating one...');
                        try {
                            await setDoc(userDocRef, {
                                uid: user.uid,
                                email: user.email,
                                displayName: user.displayName || user.email?.split('@')[0] || 'User',
                                photoURL: user.photoURL || null,
                                createdAt: new Date(),
                                enrolledCourses: [],
                                progress: {},
                                role: 'user' // Default role for all new users
                            });
                            // Reload the document
                            userDoc = await getDoc(userDocRef);
                            console.log('User document created successfully in loadUserInfo');
                        } catch (createError) {
                            console.error('Error creating user document in loadUserInfo:', createError);
                        }
                    }
                    
                    if (userDoc.exists()) {
                        userData = userDoc.data();
                        console.log('User data loaded from Firestore:', userData);
                        // Use Firestore data if available
                        if (userData.displayName) {
                            displayName = userData.displayName;
                        } else if (userData.firstName && userData.lastName) {
                            displayName = `${userData.firstName} ${userData.lastName}`.trim();
                        }
                        
                        if (userData.photoURL) {
                            photoURL = userData.photoURL;
                        }
                    } else {
                        console.log('User document still does not exist after creation attempt');
                    }
                } catch (error) {
                    console.error('Error loading user data from Firestore:', error);
                    userData = null;
                }

                // Update user name in header - BUT only if we're on overview section
                const userName = document.getElementById('userName');
                const userNameMini = document.getElementById('userNameMini');
                
                // Get firstName - prioritize from userData.firstName
                let firstName = 'Student';
                if (userData && userData.firstName) {
                    firstName = userData.firstName.trim();
                } else if (displayName) {
                    firstName = displayName.split(' ')[0].trim() || 'Student';
                }
                
                if (!firstName || firstName === 'User' || firstName === '' || firstName.toLowerCase() === 'user') {
                    firstName = 'Student';
                }
                
                // Cache the first name globally for immediate access
                window.cachedUserFirstName = firstName;
                
                const currentSection = document.querySelector('.content-section.active');
                const isOverview = currentSection && currentSection.id === 'overview';
                
                if (userName) {
                    if (isOverview) {
                        // Always show "Welcome, [FirstName]" when on overview section
                        userName.textContent = firstName;
                        userName.style.display = 'inline';
                    } else {
                        // Not on overview - hide and clear userName
                        userName.style.display = 'none';
                        userName.textContent = '';
                    }
                }
                if (userNameMini) {
                    userNameMini.textContent = firstName;
                }

                // Update user avatar
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar) {
                    if (photoURL) {
                        // Use photo URL
                        userAvatar.innerHTML = `<img src="${photoURL}" alt="${displayName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        // Use initials
                        const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                        userAvatar.textContent = initials;
                    }
                }

                console.log('User info loaded:', { displayName, firstName, photoURL });
                
                // Check if user is a Google user and show/hide set password option
                if (user && user.providerData) {
                    const isGoogleUser = user.providerData.some(provider => provider.providerId === 'google.com');
                    const hasEmailPassword = user.providerData.some(provider => provider.providerId === 'password');
                    
                    const setPasswordField = document.getElementById('setPasswordField');
                    if (setPasswordField) {
                        // Show set password field only if user is Google user and doesn't have email/password linked
                        if (isGoogleUser && !hasEmailPassword) {
                            setPasswordField.style.display = 'block';
                        } else {
                            setPasswordField.style.display = 'none';
                        }
                    }
                    
                    // Update sign-in method text
                    const signInMethodText = document.getElementById('signInMethodText');
                    if (signInMethodText) {
                        if (isGoogleUser && hasEmailPassword) {
                            signInMethodText.textContent = 'Google & Email/Password';
                        } else if (isGoogleUser) {
                            signInMethodText.textContent = 'Google';
                        } else if (hasEmailPassword) {
                            signInMethodText.textContent = 'Email/Password';
                        } else {
                            signInMethodText.textContent = 'Unknown';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        };
        
        // Handle Set Password functionality for Google users
        (function() {
            const setPasswordBtn = document.getElementById('setPasswordBtn');
            const setPasswordForm = document.getElementById('setPasswordForm');
            const savePasswordBtn = document.getElementById('savePasswordBtn');
            const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');
            const passwordError = document.getElementById('passwordError');
            const passwordSuccess = document.getElementById('passwordSuccess');
            
            if (setPasswordBtn) {
                setPasswordBtn.addEventListener('click', () => {
                    if (setPasswordForm) {
                        setPasswordForm.style.display = 'block';
                        setPasswordBtn.style.display = 'none';
                    }
                });
            }
            
            if (cancelPasswordBtn) {
                cancelPasswordBtn.addEventListener('click', () => {
                    if (setPasswordForm) {
                        setPasswordForm.style.display = 'none';
                        if (setPasswordBtn) setPasswordBtn.style.display = 'inline-block';
                        if (newPasswordInput) newPasswordInput.value = '';
                        if (confirmPasswordInput) confirmPasswordInput.value = '';
                        if (passwordError) {
                            passwordError.style.display = 'none';
                            passwordError.textContent = '';
                        }
                        if (passwordSuccess) {
                            passwordSuccess.style.display = 'none';
                            passwordSuccess.textContent = '';
                        }
                    }
                });
            }
            
            if (savePasswordBtn) {
                savePasswordBtn.addEventListener('click', async () => {
                    const newPassword = newPasswordInput?.value || '';
                    const confirmPassword = confirmPasswordInput?.value || '';
                    
                    // Hide previous messages
                    if (passwordError) {
                        passwordError.style.display = 'none';
                        passwordError.textContent = '';
                    }
                    if (passwordSuccess) {
                        passwordSuccess.style.display = 'none';
                        passwordSuccess.textContent = '';
                    }
                    
                    // Validate
                    if (!newPassword || newPassword.length < 6) {
                        if (passwordError) {
                            passwordError.textContent = 'Password must be at least 6 characters long.';
                            passwordError.style.display = 'block';
                        }
                        return;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        if (passwordError) {
                            passwordError.textContent = 'Passwords do not match.';
                            passwordError.style.display = 'block';
                        }
                        return;
                    }
                    
                    try {
                        const { getAuth, EmailAuthProvider, linkWithCredential } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                        const auth = getAuth();
                        const user = auth.currentUser;
                        
                        if (!user || !user.email) {
                            throw new Error('User not found');
                        }
                        
                        // Create email/password credential
                        const credential = EmailAuthProvider.credential(user.email, newPassword);
                        
                        // Link the credential to the Google account
                        await linkWithCredential(user, credential);
                        
                        // Show success message
                        if (passwordSuccess) {
                            passwordSuccess.textContent = 'Password set successfully! You can now login with email/password.';
                            passwordSuccess.style.display = 'block';
                        }
                        
                        // Hide form after 2 seconds
                        setTimeout(() => {
                            if (setPasswordForm) setPasswordForm.style.display = 'none';
                            if (setPasswordBtn) setPasswordBtn.style.display = 'inline-block';
                            if (newPasswordInput) newPasswordInput.value = '';
                            if (confirmPasswordInput) confirmPasswordInput.value = '';
                            if (passwordSuccess) passwordSuccess.style.display = 'none';
                            
                            // Reload user info to update UI
                            if (window.loadUserInfo) {
                                window.loadUserInfo();
                            }
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Error setting password:', error);
                        if (passwordError) {
                            let errorMsg = 'Failed to set password. Please try again.';
                            if (error.code === 'auth/email-already-in-use') {
                                errorMsg = 'This email is already in use with a different account.';
                            } else if (error.code === 'auth/weak-password') {
                                errorMsg = 'Password is too weak. Please choose a stronger password.';
                            } else if (error.code === 'auth/requires-recent-login') {
                                errorMsg = 'For security, please sign out and sign in again, then try setting your password.';
                            }
                            passwordError.textContent = errorMsg;
                            passwordError.style.display = 'block';
                        }
                    }
                });
            }
        })();
        
        // Call loadUserInfo when Firebase is ready
        // Wait for Firebase to be initialized
        if (window.firebase && window.firebase.auth && window.firebase.db) {
            // Firebase already ready, call immediately
            loadUserInfo();
        } else {
            // Wait for Firebase to be ready
            const checkFirebase = setInterval(() => {
                if (window.firebase && window.firebase.auth && window.firebase.db) {
                    clearInterval(checkFirebase);
                    loadUserInfo();
                }
            }, 100);
            
            // Safety timeout - stop checking after 5 seconds
            setTimeout(() => {
                clearInterval(checkFirebase);
            }, 5000);
        }
    </script>
    
    <script>
        // Header Search Autocomplete Functionality
        (function() {
            const headerSearchInput = document.getElementById('headerSearchInput');
            const headerSearchDropdown = document.getElementById('headerSearchDropdown');
            const headerSearchSuggestions = document.getElementById('headerSearchSuggestions');
            const headerSearchClear = document.getElementById('headerSearchClear');
            
            // Define all searchable items including profile subsections
            const searchItems = [
                // Main Sections
                { title: 'Overview', section: 'overview', type: 'section', icon: 'grid' },
                { title: 'My Programs', section: 'programs', type: 'section', icon: 'book' },
                { title: 'Progress', section: 'progress', type: 'section', icon: 'activity' },
                { title: 'Resources', section: 'resources', type: 'section', icon: 'book' },
                { title: 'Marketplace', section: 'marketplace', type: 'section', icon: 'shopping' },
                { title: 'Tasks', section: 'tasks', type: 'section', icon: 'check' },
                { title: 'Notes', section: 'notes', type: 'section', icon: 'file-text' },
                { title: 'Payment', section: 'payment', type: 'section', icon: 'card' },
                { title: 'Help', section: 'help', type: 'section', icon: 'help' },
                { title: 'Profile', section: 'profile', type: 'section', icon: 'user' },
                { title: 'Settings', section: 'settings', type: 'section', icon: 'settings' },
                
                // Profile Subsections
                { title: 'Personal Information', section: 'profile', subsection: 'personalInfoSection', type: 'subsection', icon: 'user', meta: 'Profile' },
                { title: 'Google Account', section: 'profile', subsection: 'googleAccountSection', type: 'subsection', icon: 'user', meta: 'Profile' },
                { title: 'Preferences', section: 'profile', subsection: 'preferencesSection', type: 'subsection', icon: 'sliders', meta: 'Profile' },
                { title: 'Subscription', section: 'profile', subsection: 'subscriptionSection', type: 'subsection', icon: 'card', meta: 'Profile' },
                { title: 'Security', section: 'profile', subsection: 'securitySection', type: 'subsection', icon: 'shield', meta: 'Profile' },
                { title: 'Privacy', section: 'profile', subsection: 'privacySection', type: 'subsection', icon: 'lock', meta: 'Profile' },
                { title: 'Active Sessions', section: 'profile', subsection: 'sessionsSection', type: 'subsection', icon: 'monitor', meta: 'Profile' },
                { title: 'Notifications', section: 'profile', subsection: 'notificationsSection', type: 'subsection', icon: 'bell', meta: 'Profile' },
                { title: 'Appearance', section: 'profile', subsection: 'appearanceSection', type: 'subsection', icon: 'eye', meta: 'Profile' },
                
                // Personal Info Fields
                { title: 'Name', section: 'profile', subsection: 'personalInfoSection', type: 'field', icon: 'user', meta: 'Personal Info', fieldLabel: 'Name' },
                { title: 'Email', section: 'profile', subsection: 'personalInfoSection', type: 'field', icon: 'user', meta: 'Personal Info', fieldLabel: 'Email' },
                { title: 'Password', section: 'profile', subsection: 'personalInfoSection', type: 'field', icon: 'lock', meta: 'Personal Info', fieldLabel: 'Password' },
                { title: 'Contact', section: 'profile', subsection: 'personalInfoSection', type: 'field', icon: 'user', meta: 'Personal Info', fieldLabel: 'Contact' },
                { title: 'Job Title', section: 'profile', subsection: 'personalInfoSection', type: 'field', icon: 'user', meta: 'Personal Info', fieldLabel: 'Job Title' },
                { title: 'Location', section: 'profile', subsection: 'personalInfoSection', type: 'field', icon: 'user', meta: 'Personal Info', fieldLabel: 'Location' },
                { title: 'Website', section: 'profile', subsection: 'personalInfoSection', type: 'field', icon: 'user', meta: 'Personal Info', fieldLabel: 'Website' },
                { title: 'Bio', section: 'profile', subsection: 'personalInfoSection', type: 'field', icon: 'user', meta: 'Personal Info', fieldLabel: 'Bio' },
                { title: 'Learning Goals', section: 'profile', subsection: 'personalInfoSection', type: 'field', icon: 'user', meta: 'Personal Info', fieldLabel: 'Learning Goals' },
                { title: 'Social Links', section: 'profile', subsection: 'personalInfoSection', type: 'field', icon: 'user', meta: 'Personal Info', fieldLabel: 'Social Links' },
                
                // Google Account Fields
                { title: 'Member Since', section: 'profile', subsection: 'googleAccountSection', type: 'field', icon: 'user', meta: 'Account', fieldLabel: 'Member Since' },
                { title: 'Account Type', section: 'profile', subsection: 'googleAccountSection', type: 'field', icon: 'user', meta: 'Account', fieldLabel: 'Account Type' },
                { title: 'Programs Enrolled', section: 'profile', subsection: 'googleAccountSection', type: 'field', icon: 'user', meta: 'Account', fieldLabel: 'Programs Enrolled' },
                { title: 'Sign-In Method', section: 'profile', subsection: 'googleAccountSection', type: 'field', icon: 'user', meta: 'Account', fieldLabel: 'Sign-In Method' },
                { title: 'Google Account', section: 'profile', subsection: 'googleAccountSection', type: 'field', icon: 'user', meta: 'Account', fieldLabel: 'Google Account' },
                
                // Preferences Items
                { title: 'Email Notifications', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'bell', meta: 'Preferences', fieldLabel: 'Email Notifications' },
                { title: 'Marketing Emails', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'bell', meta: 'Preferences', fieldLabel: 'Marketing Emails' },
                { title: 'Push Notifications', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'bell', meta: 'Preferences', fieldLabel: 'Push Notifications' },
                { title: 'Course Updates', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'book', meta: 'Preferences', fieldLabel: 'Course Updates' },
                { title: 'Assignment Reminders', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'check', meta: 'Preferences', fieldLabel: 'Assignment Reminders' },
                { title: 'Study Reminders', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'check', meta: 'Preferences', fieldLabel: 'Study Reminders' },
                { title: 'Animations', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'eye', meta: 'Preferences', fieldLabel: 'Animations' },
                { title: 'Compact Sidebar', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'settings', meta: 'Preferences', fieldLabel: 'Compact Sidebar' },
                { title: 'Auto-play Videos', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'settings', meta: 'Preferences', fieldLabel: 'Auto-play Videos' },
                { title: 'Progress Tracking', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'activity', meta: 'Preferences', fieldLabel: 'Progress Tracking' },
                { title: 'Language', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'settings', meta: 'Preferences', fieldLabel: 'Language' },
                { title: 'Timezone', section: 'profile', subsection: 'preferencesSection', type: 'field', icon: 'settings', meta: 'Preferences', fieldLabel: 'Timezone' }
            ];
            
            // Icon SVG templates
            const icons = {
                grid: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>',
                book: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>',
                activity: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>',
                award: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>',
                shopping: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>',
                check: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3 8-8"></path><path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h9"></path></svg>',
                users: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
                card: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>',
                help: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
                user: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
                settings: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path></svg>',
                sliders: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>',
                shield: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',
                lock: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>',
                monitor: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>',
                bell: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>',
                eye: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'
            };
            
            // Search and filter items
            function performSearch(query) {
                if (!query) return [];
                
                const lowercaseQuery = query.toLowerCase();
                const matches = searchItems.filter(item => 
                    item.title.toLowerCase().includes(lowercaseQuery) ||
                    (item.meta && item.meta.toLowerCase().includes(lowercaseQuery))
                );
                
                return matches.slice(0, 12);
            }
            
            // Highlight matching text
            function highlightMatch(text, query) {
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<span class="search-highlight">$1</span>');
            }
            
            let selectedIndex = -1;
            let currentMatches = [];
            
            // Show suggestions
            function showSuggestions(query) {
                currentMatches = performSearch(query);
                
                if (currentMatches.length === 0) {
                    headerSearchDropdown.classList.remove('show');
                    selectedIndex = -1;
                    return;
                }
                
                selectedIndex = -1;
                headerSearchSuggestions.innerHTML = currentMatches.map((item, index) => `
                    <div class="header-search-item" data-section="${item.section}" ${item.subsection ? `data-subsection="${item.subsection}"` : ''} ${item.fieldLabel ? `data-field-label="${item.fieldLabel}"` : ''} data-index="${index}">
                        <div class="header-search-item-icon">
                            ${icons[item.icon] || icons.grid}
                        </div>
                        <div class="header-search-item-content">
                            <div class="header-search-item-title">${highlightMatch(item.title, query)}</div>
                            ${item.meta ? `<div class="header-search-item-meta">${item.meta}</div>` : ''}
                        </div>
                    </div>
                `).join('');
                
                headerSearchDropdown.classList.add('show');
                
                // Add click handlers to search items
                const searchItemElements = headerSearchSuggestions.querySelectorAll('.header-search-item');
                searchItemElements.forEach(el => {
                    el.addEventListener('click', function() {
                        handleSearchItemClick(this);
                    });
                });
                
                // Update scroll container max height
                headerSearchSuggestions.style.maxHeight = '400px';
                headerSearchSuggestions.style.overflowY = 'auto';
            }
            
            // Handle search item click
            function handleSearchItemClick(element) {
                const section = element.getAttribute('data-section');
                const subsection = element.getAttribute('data-subsection');
                const fieldLabel = element.getAttribute('data-field-label');
                
                // Navigate to section
                if (typeof navigateToSection === 'function') {
                    navigateToSection(section);
                }
                
                // If there's a subsection, navigate to it
                if (subsection) {
                    setTimeout(() => {
                        navigateToProfileSubsection(subsection);
                        
                        // If there's a field label, scroll to it and highlight
                        if (fieldLabel) {
                            setTimeout(() => {
                                scrollToAndHighlightField(fieldLabel);
                            }, 200);
                        }
                    }, 150);
                }
                
                // Clear search
                headerSearchInput.value = '';
                headerSearchClear.style.display = 'none';
                headerSearchDropdown.classList.remove('show');
                selectedIndex = -1;
            }
            
            // Scroll to and highlight a field by its label text
            function scrollToAndHighlightField(labelText) {
                // Find all profile field labels
                const labels = document.querySelectorAll('.profile-field-label');
                
                // Find the label that matches
                let targetField = null;
                labels.forEach(label => {
                    if (label.textContent.trim() === labelText) {
                        targetField = label.closest('.profile-field');
                    }
                });
                
                if (targetField) {
                    // Ensure subsection is visible
                    const subsection = targetField.closest('.profile-subsection');
                    if (subsection) {
                        subsection.style.display = 'block';
                        subsection.classList.add('active');
                    }
                    
                    // Scroll to the field
                    setTimeout(() => {
                        targetField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Simple highlight
                        targetField.classList.add('search-highlight-field');
                        
                        // Remove highlight after 2 seconds
                        setTimeout(() => {
                            targetField.classList.remove('search-highlight-field');
                        }, 2000);
                    }, 100);
                }
            }
            
            // Update selected item highlight
            function updateSelectedItem() {
                const items = headerSearchSuggestions.querySelectorAll('.header-search-item');
                items.forEach((item, index) => {
                    if (index === selectedIndex) {
                        item.classList.add('selected');
                        // Scroll into view
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }
            
            // Handle keyboard navigation
            function handleKeyboardNavigation(e) {
                if (!headerSearchDropdown.classList.contains('show')) return;
                
                const items = headerSearchSuggestions.querySelectorAll('.header-search-item');
                if (items.length === 0) return;
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = (selectedIndex + 1) % items.length;
                    updateSelectedItem();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
                    updateSelectedItem();
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    const selectedItem = items[selectedIndex];
                    if (selectedItem) {
                        handleSearchItemClick(selectedItem);
                    }
                }
            }
            
            // Navigate to profile subsection
            function navigateToProfileSubsection(subsectionId) {
                const profileNavItems = document.querySelectorAll('.profile-nav-item');
                const profileSubsections = document.querySelectorAll('.profile-subsection');
                const profileTabs = document.querySelectorAll('.profile-tab');
                
                // Find the corresponding nav item
                const targetNavItem = Array.from(profileNavItems).find(item => 
                    item.getAttribute('data-section') === subsectionId
                );
                
                // Also activate the corresponding profile tab if it exists
                const targetTab = Array.from(profileTabs).find(tab => 
                    tab.getAttribute('data-section') === subsectionId
                );
                
                if (targetTab) {
                    // Remove active class from all tabs
                    profileTabs.forEach(tab => tab.classList.remove('active'));
                    // Add active class to target tab
                    targetTab.classList.add('active');
                }
                
                if (targetNavItem) {
                    // Remove active class from all nav items
                    profileNavItems.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to target item
                    targetNavItem.classList.add('active');
                }
                
                // Hide all subsections
                profileSubsections.forEach(section => {
                    section.style.display = 'none';
                    section.classList.remove('active');
                });
                
                // Show target subsection
                const targetSection = document.getElementById(subsectionId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    targetSection.classList.add('active');
                }
                
                // Update URL with subsection
                const subsectionMap = {
                    'personalInfoSection': 'personal',
                    'googleAccountSection': 'account',
                    'preferencesSection': 'preferences',
                    'advancedSection': 'advanced'
                };
                const subsectionName = subsectionMap[subsectionId];
                if (subsectionName && typeof updateUrlForSubsection === 'function') {
                    updateUrlForSubsection('profile', subsectionName);
                }
            }
            
            // Event listeners
            if (headerSearchInput) {
                headerSearchInput.addEventListener('input', function(e) {
                    const query = e.target.value.trim();
                    
                    if (query) {
                        headerSearchClear.style.display = 'block';
                        showSuggestions(query);
                    } else {
                        headerSearchClear.style.display = 'none';
                        headerSearchDropdown.classList.remove('show');
                        selectedIndex = -1;
                    }
                });
                
                headerSearchInput.addEventListener('focus', function() {
                    if (this.value.trim()) {
                        showSuggestions(this.value.trim());
                    }
                });
                
                // Keyboard navigation
                headerSearchInput.addEventListener('keydown', function(e) {
                    handleKeyboardNavigation(e);
                });
                
                // Keyboard shortcut: '/' to focus search
                document.addEventListener('keydown', function(e) {
                    if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                        e.preventDefault();
                        headerSearchInput.focus();
                    } else if (e.key === 'Escape' && document.activeElement === headerSearchInput) {
                        headerSearchInput.blur();
                        headerSearchDropdown.classList.remove('show');
                        selectedIndex = -1;
                    }
                });
            }
            
            if (headerSearchClear) {
                headerSearchClear.addEventListener('click', function() {
                    headerSearchInput.value = '';
                    this.style.display = 'none';
                    headerSearchDropdown.classList.remove('show');
                    headerSearchInput.focus();
                });
            }
            
            // Click outside to close dropdown
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.header-search-bar')) {
                    headerSearchDropdown.classList.remove('show');
                }
            });
        })();
    </script>
    
    <script>
        // Profile Navigation Handler
        document.addEventListener('DOMContentLoaded', function() {
            const profileNavItems = document.querySelectorAll('.profile-nav-item');
            const profileSubsections = document.querySelectorAll('.profile-subsection');
            
            profileNavItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const targetSection = this.getAttribute('data-section');
                    
                    // Remove active class from all nav items
                    profileNavItems.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Hide all subsections
                    profileSubsections.forEach(section => {
                        section.style.display = 'none';
                        section.classList.remove('active');
                    });
                    
                    // Show target subsection
                    const target = document.getElementById(targetSection);
                    if (target) {
                        target.style.display = 'block';
                        target.classList.add('active');
                    }
                });
            });
            
            // Profile Panel Collapse/Expand Toggle
            const profilePanelToggle = document.getElementById('profilePanelToggle');
            const profileRightPanel = document.getElementById('profileRightPanel');
            const profileSection = document.getElementById('profile');
            
            if (profilePanelToggle) {
                profilePanelToggle.addEventListener('click', function() {
                    const isCollapsed = profileRightPanel.classList.toggle('collapsed');
                    
                    // Update button title
                    profilePanelToggle.title = isCollapsed ? 'Expand panel' : 'Collapse panel';
                    
                    // Update profile section margin based on collapse state
                    updateProfileSectionMargin(isCollapsed);
                    
                    // Save state to localStorage
                    try {
                        localStorage.setItem('profilePanelCollapsed', isCollapsed);
                    } catch (error) {
                        console.error('Error saving profile panel state:', error);
                    }
                });
            }
            
            // Function to update profile section margin
            function updateProfileSectionMargin(isCollapsed) {
                if (profileSection) {
                    const sidebarWidth = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
                    const collapsedWidth = '64px';
                    profileSection.style.marginRight = isCollapsed ? collapsedWidth : sidebarWidth;
                }
            }
            
            // Initialize profile panel collapse state from localStorage
            try {
                const panelCollapsed = localStorage.getItem('profilePanelCollapsed');
                if (panelCollapsed === 'true' && profileRightPanel && profileSection) {
                    profileRightPanel.classList.add('collapsed');
                    updateProfileSectionMargin(true);
                    if (profilePanelToggle) {
                        profilePanelToggle.title = 'Expand panel';
                    }
                } else if (profileSection) {
                    // Set initial margin when not collapsed
                    updateProfileSectionMargin(false);
                }
            } catch (error) {
                console.error('Error loading profile panel state:', error);
            }
        });
    </script>
    
    <script type="module">
        // Load and display social links in profile section
        import { doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
                // Helper function to detect social platform from URL and return icon info
        function getSocialIconFromUrl(url) {
            if (!url || !url.trim()) return null;
            
            const urlLower = url.toLowerCase();
            
            // Twitter/X
            if (urlLower.includes('twitter.com') || urlLower.includes('x.com')) {
                return {
                    icon: '/assets/images/twitter.png',
                    alt: 'Twitter',
                    platform: 'twitter'
                };
            }
            
            // LinkedIn
            if (urlLower.includes('linkedin.com')) {
                return {
                    icon: '/assets/images/linkedin.png',
                    alt: 'LinkedIn',
                    platform: 'linkedin'
                };
            }
            
            // GitHub
            if (urlLower.includes('github.com')) {
                return {
                    icon: null,
                    alt: 'GitHub',
                    platform: 'github',
                    text: 'GitHub'
                };
            }
            
            // Instagram
            if (urlLower.includes('instagram.com')) {
                return {
                    icon: '/assets/images/instagram.png',
                    alt: 'Instagram',
                    platform: 'instagram'
                };
            }
            
            // Facebook
            if (urlLower.includes('facebook.com')) {
                return {
                    icon: '/assets/images/facebook.png',
                    alt: 'Facebook',
                    platform: 'facebook'
                };
            }
            
            // YouTube
            if (urlLower.includes('youtube.com') || urlLower.includes('youtu.be')) {
                return {
                    icon: '/assets/images/youtube.png',
                    alt: 'YouTube',
                    platform: 'youtube'
                };
            }
            
            // Pinterest
            if (urlLower.includes('pinterest.com')) {
                return {
                    icon: '/assets/images/pinterest.png',
                    alt: 'Pinterest',
                    platform: 'pinterest'
                };
            }
            
            // Telegram
            if (urlLower.includes('telegram.org') || urlLower.includes('t.me')) {
                return {
                    icon: '/assets/images/telegram.png',
                    alt: 'Telegram',
                    platform: 'telegram'
                };
            }
            
            // TikTok
            if (urlLower.includes('tiktok.com')) {
                return {
                    icon: '/assets/images/tik-tok.png',
                    alt: 'TikTok',
                    platform: 'tiktok'
                };
            }
            
            // WhatsApp
            if (urlLower.includes('whatsapp.com') || urlLower.includes('wa.me')) {
                return {
                    icon: '/assets/images/whatsapp.png',
                    alt: 'WhatsApp',
                    platform: 'whatsapp'
                };
            }
            
            // Default: show as generic link
            return {
                icon: null,
                alt: 'Social Link',
                platform: 'other',
                text: 'Link'
            };
        }

        // Helper function to create a social link element
        function createSocialLinkElement(url, iconInfo) {
            const link = document.createElement('a');
            link.href = url.trim();
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.className = 'social-logo-link';
            
            if (iconInfo.icon) {
                link.innerHTML = `<img src="${iconInfo.icon}" alt="${iconInfo.alt}" class="social-logo-img" style="width: 32px; height: 32px; object-fit: contain;">`;
            } else {
                link.style.textDecoration = 'none';
                link.style.color = 'var(--color-text-primary, #ffffff)';
                link.textContent = iconInfo.text || iconInfo.alt || 'Link';
            }
            
            return link;
        }

        async function loadSocialLinks() {
            try {
                if (!window.firebase || !window.firebase.auth || !window.firebase.db) {
                    console.log('Firebase not ready yet, will retry');
                    setTimeout(loadSocialLinks, 500);
                    return;
                }

                const auth = window.firebase.auth;
                const db = window.firebase.db;
                const user = auth.currentUser;

                if (!user) {
                    console.log('No user logged in');
                    return;
                }
                
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const social = userData.social || {};
                    
                    const profileSocialText = document.getElementById('profileSocialText');
                    const profileSocialLogos = document.getElementById('profileSocialLogos');

                    if (!profileSocialText || !profileSocialLogos) {
                        return;
                    }

                    // Collect all social links (standard + dynamic)
                    const allSocialLinks = [];
                    
                    // Standard social links
                    if (social.twitter && social.twitter.trim()) {
                        allSocialLinks.push({ url: social.twitter.trim(), type: 'twitter' });
                    }
                    if (social.linkedIn && social.linkedIn.trim()) {
                        allSocialLinks.push({ url: social.linkedIn.trim(), type: 'linkedin' });
                    }
                    if (social.github && social.github.trim()) {
                        allSocialLinks.push({ url: social.github.trim(), type: 'github' });
                    }
                    
                    // Dynamic social links (keys starting with 'dynamic_')
                    // Sort them numerically to maintain order
                    const dynamicKeys = Object.keys(social)
                        .filter(key => key.startsWith('dynamic_'))
                        .sort((a, b) => {
                            const numA = parseInt(a.replace('dynamic_', ''));
                            const numB = parseInt(b.replace('dynamic_', ''));
                            return numA - numB;
                        });
                    
                    dynamicKeys.forEach(key => {
                        const url = social[key];
                        if (url && url.trim()) {
                            allSocialLinks.push({ url: url.trim(), type: 'dynamic' });
                        }
                    });

                    // Check if any social links exist
                    if (allSocialLinks.length > 0) {
                        // Hide "Not provided" text
                        profileSocialText.style.display = 'none';
                        
                        // Show logos container
                        profileSocialLogos.style.display = 'flex';
                        profileSocialLogos.innerHTML = '';

                        // Add logos for each social link
                        allSocialLinks.forEach(linkData => {
                            const iconInfo = getSocialIconFromUrl(linkData.url);
                            if (iconInfo) {
                                const linkElement = createSocialLinkElement(linkData.url, iconInfo);
                                profileSocialLogos.appendChild(linkElement);
                            }
                        });
                    } else {
                        // No social links, show "Not provided"
                        profileSocialText.style.display = 'inline';
                        profileSocialLogos.style.display = 'none';
                        profileSocialLogos.innerHTML = '';
                    }
                }
            } catch (error) {
                console.error('Error loading social links:', error);
            }
        }

        // Load social links when profile section is shown
        function observeProfileSection() {
            const profileSection = document.getElementById('profile');
            if (!profileSection) {
                setTimeout(observeProfileSection, 500);
                return;
            }

            // Use MutationObserver to detect when profile section becomes active
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const isActive = profileSection.classList.contains('active');
                        if (isActive && typeof loadSocialLinks === 'function') {
                            // Call immediately when profile section becomes active
                            loadSocialLinks();
                        }
                    }
                });
            });

            observer.observe(profileSection, {
                attributes: true,
                attributeFilter: ['class']
            });

            // Also check immediately if profile section is already active
            if (profileSection.classList.contains('active') && typeof loadSocialLinks === 'function') {
                loadSocialLinks();
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(observeProfileSection, 500);
            });
        } else {
            setTimeout(observeProfileSection, 500);
        }
    </script>
    
    <script>
        // Dynamic social links functionality
        (function() {
            const MAX_SOCIAL_LINKS = 5;
            let dynamicSocialLinkCount = 0;
            
            function getTotalSocialLinkCount() {
                // Count the 3 fixed social links + dynamic ones
                const fixedInputs = document.querySelectorAll('.profile-social-inputs input[data-social-type]');
                const dynamicInputs = document.querySelectorAll('#dynamicSocialLinks .profile-field-input');
                return fixedInputs.length + dynamicInputs.length;
            }
            
            function updateAddSocialButton() {
                const addSocialBtn = document.getElementById('addSocialBtn');
                if (!addSocialBtn) return;
                
                const totalCount = getTotalSocialLinkCount();
                if (totalCount >= MAX_SOCIAL_LINKS) {
                    addSocialBtn.disabled = true;
                    addSocialBtn.style.opacity = '0.4';
                    addSocialBtn.style.cursor = 'not-allowed';
                } else {
                    addSocialBtn.disabled = false;
                    addSocialBtn.style.opacity = '1';
                    addSocialBtn.style.cursor = 'pointer';
                }
            }
            
            function addDynamicSocialLink() {
                const totalCount = getTotalSocialLinkCount();
                if (totalCount >= MAX_SOCIAL_LINKS) {
                    return;
                }
                
                const dynamicContainer = document.getElementById('dynamicSocialLinks');
                if (!dynamicContainer) return;
                
                dynamicSocialLinkCount++;
                const linkId = `dynamicSocialLink_${dynamicSocialLinkCount}`;
                
                const linkRow = document.createElement('div');
                linkRow.className = 'dynamic-social-link-row';
                linkRow.id = linkId;
                
                const input = document.createElement('input');
                input.type = 'url';
                input.className = 'profile-field-input';
                input.placeholder = 'Social media profile URL';
                input.style.display = 'block';
                input.setAttribute('data-social-dynamic', 'true');
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-social-btn';
                removeBtn.textContent = 'Remove';
                removeBtn.onclick = function() {
                    linkRow.remove();
                    updateAddSocialButton();
                };
                
                linkRow.appendChild(input);
                linkRow.appendChild(removeBtn);
                dynamicContainer.appendChild(linkRow);
                
                updateAddSocialButton();
            }
            
            function showAddSocialButton() {
                const addSocialBtn = document.getElementById('addSocialBtn');
                const profileSocialInputs = document.querySelector('.profile-social-inputs');
                if (addSocialBtn && profileSocialInputs && profileSocialInputs.style.display !== 'none') {
                    addSocialBtn.style.display = 'block';
                    updateAddSocialButton();
                }
            }
            
            function hideAddSocialButton() {
                const addSocialBtn = document.getElementById('addSocialBtn');
                if (addSocialBtn) {
                    addSocialBtn.style.display = 'none';
                }
            }
            
            // Initialize when DOM is ready
            function initDynamicSocialLinks() {
                const addSocialBtn = document.getElementById('addSocialBtn');
                if (!addSocialBtn) {
                    setTimeout(initDynamicSocialLinks, 500);
                    return;
                }
                
                // Add click handler
                addSocialBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    addDynamicSocialLink();
                });
                
                // Observe when edit mode is activated
                const profileSocialInputs = document.querySelector('.profile-social-inputs');
                if (profileSocialInputs) {
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                                const isVisible = profileSocialInputs.style.display !== 'none';
                                if (isVisible) {
                                    showAddSocialButton();
                                } else {
                                    hideAddSocialButton();
                                }
                            }
                        });
                    });
                    
                    observer.observe(profileSocialInputs, {
                        attributes: true,
                        attributeFilter: ['style']
                    });
                    
                    // Check initial state
                    if (profileSocialInputs.style.display !== 'none') {
                        showAddSocialButton();
                    }
                }
            }
            
            // Also listen for edit button clicks (if dashboard.js handles edit mode)
            const profileEditBtn = document.getElementById('profileEditBtn');
            if (profileEditBtn) {
                profileEditBtn.addEventListener('click', function() {
                    setTimeout(showAddSocialButton, 100);
                });
            }
            
            // Function to get all social links (for saving)
            window.getAllSocialLinks = function() {
                const social = {
                    twitter: (document.getElementById('socialTwitter')?.value || '').trim(),
                    linkedIn: (document.getElementById('socialLinkedIn')?.value || '').trim(),
                    github: (document.getElementById('socialGitHub')?.value || '').trim()
                };
                
                // Get dynamic social links - preserve order and only save non-empty values
                const dynamicInputs = document.querySelectorAll('#dynamicSocialLinks .profile-field-input');
                let dynamicIndex = 0;
                dynamicInputs.forEach((input) => {
                    const value = input.value.trim();
                    if (value) {
                        // Store as dynamic_0, dynamic_1, etc. in order
                        social[`dynamic_${dynamicIndex}`] = value;
                        dynamicIndex++;
                    }
                });
                
                return social;
            };
            
            // Function to load dynamic social links (called when profile data is loaded)
            window.loadDynamicSocialLinks = function(socialData) {
                if (!socialData || typeof socialData !== 'object') return;
                
                const dynamicContainer = document.getElementById('dynamicSocialLinks');
                if (!dynamicContainer) return;
                
                // Clear existing dynamic links
                dynamicContainer.innerHTML = '';
                dynamicSocialLinkCount = 0;
                
                // Find dynamic social links (keys that start with 'dynamic_')
                // Sort them numerically to maintain order
                const dynamicKeys = Object.keys(socialData)
                    .filter(key => key.startsWith('dynamic_'))
                    .sort((a, b) => {
                        const numA = parseInt(a.replace('dynamic_', ''));
                        const numB = parseInt(b.replace('dynamic_', ''));
                        return numA - numB;
                    });
                
                dynamicKeys.forEach((key) => {
                    const value = socialData[key];
                    if (value && value.trim()) {
                        dynamicSocialLinkCount++;
                        const linkId = `dynamicSocialLink_${dynamicSocialLinkCount}`;
                        
                        const linkRow = document.createElement('div');
                        linkRow.className = 'dynamic-social-link-row';
                        linkRow.id = linkId;
                        
                        const input = document.createElement('input');
                        input.type = 'url';
                        input.className = 'profile-field-input';
                        input.placeholder = 'Social media profile URL';
                        input.style.display = 'block';
                        input.value = value.trim();
                        input.setAttribute('data-social-dynamic', 'true');
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-social-btn';
                        removeBtn.textContent = 'Remove';
                        removeBtn.onclick = function() {
                            linkRow.remove();
                            updateAddSocialButton();
                        };
                        
                        linkRow.appendChild(input);
                        linkRow.appendChild(removeBtn);
                        dynamicContainer.appendChild(linkRow);
                    }
                });
                
                updateAddSocialButton();
            };
            
            // Hook into save button to collect all social links and save to Firebase
            const profileSaveBtn = document.getElementById('profileSaveBtn');
            if (profileSaveBtn) {
                profileSaveBtn.addEventListener('click', async function(e) {
                    // Wait a bit to let other save handlers run first, then save social links
                    setTimeout(async () => {
                        // Get all social links including dynamic ones
                        const allSocialLinks = window.getAllSocialLinks ? window.getAllSocialLinks() : {};
                        
                        console.log('Saving social links:', allSocialLinks);
                        
                        // Save to Firebase
                        try {
                            if (window.firebase && window.firebase.auth && window.firebase.db) {
                                const user = window.firebase.auth.currentUser;
                                if (user) {
                                    const userRef = doc(window.firebase.db, 'users', user.uid);
                                    
                                    // Update social links in Firebase (merge with existing data)
                                    await updateDoc(userRef, {
                                        social: allSocialLinks
                                    });
                                    
                                    console.log('Social links saved successfully:', allSocialLinks);
                                    
                                    // Reload social links after save
                                    setTimeout(() => {
                                        if (typeof loadSocialLinks === 'function') {
                                            loadSocialLinks();
                                        }
                                    }, 500);
                                } else {
                                    console.error('No user logged in');
                                }
                            } else {
                                console.error('Firebase not initialized');
                            }
                        } catch (error) {
                            console.error('Error saving social links:', error);
                        }
                    }, 100);
                    
                    setTimeout(updateAddSocialButton, 100);
                });
            }
            
            // Initialize
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initDynamicSocialLinks);
            } else {
                initDynamicSocialLinks();
            }
        })();
    </script>
    
    <script>
        // Sync preferences section toggles with settings section toggles
        (function() {
            // Mapping between preferences IDs and settings IDs
            const toggleMapping = {
                'emailNotificationsToggle': 'emailNotifications',
                'pushNotificationsPref': 'pushNotifications',
                'courseUpdatesPref': 'courseUpdates',
                'assignmentRemindersPref': 'assignmentReminders',
                'studyRemindersPref': 'studyReminders',
                'animationsPref': 'animations',
                'compactSidebarPref': 'compactSidebar',
                'autoPlayVideosPref': 'autoPlayVideos',
                'progressTrackingPref': 'progressTracking',
                'languagePref': 'language',
                'timezonePref': 'timezone'
            };
            
            // Sync function
            function syncToggles(sourceId, targetId) {
                const source = document.getElementById(sourceId);
                const target = document.getElementById(targetId);
                if (source && target) {
                    if (source.type === 'checkbox') {
                        target.checked = source.checked;
                    } else if (source.tagName === 'SELECT') {
                        target.value = source.value;
                    }
                }
            }
            
            // Set up bidirectional syncing
            function setupSync() {
                Object.keys(toggleMapping).forEach(prefId => {
                    const settingsId = toggleMapping[prefId];
                    const prefElement = document.getElementById(prefId);
                    const settingsElement = document.getElementById(settingsId);
                    
                    if (prefElement && settingsElement) {
                        // Sync from preferences to settings
                        prefElement.addEventListener('change', function() {
                            syncToggles(prefId, settingsId);
                        });
                        
                        // Sync from settings to preferences
                        settingsElement.addEventListener('change', function() {
                            syncToggles(settingsId, prefId);
                        });
                    }
                });
            }
            
            // Load settings and sync on page load
            function loadAndSyncSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('dashboardSettings') || '{}');
                    
                    // Sync checkbox states
                    Object.keys(toggleMapping).forEach(prefId => {
                        const settingsId = toggleMapping[prefId];
                        const prefElement = document.getElementById(prefId);
                        const settingsElement = document.getElementById(settingsId);
                        
                        if (prefElement && settingsElement) {
                            const settingKey = settingsId.replace(/([A-Z])/g, '_$1').toLowerCase();
                            const value = settings[settingsId] || settings[settingKey];
                            
                            if (prefElement.type === 'checkbox') {
                                const checked = value !== undefined ? value : (settingsElement.checked || false);
                                prefElement.checked = checked;
                                settingsElement.checked = checked;
                            } else if (prefElement.tagName === 'SELECT') {
                                const val = value || settingsElement.value || prefElement.value;
                                prefElement.value = val;
                                settingsElement.value = val;
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }
            
            // Initialize
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(function() {
                        setupSync();
                        loadAndSyncSettings();
                    }, 500);
                });
            } else {
                setTimeout(function() {
                    setupSync();
                    loadAndSyncSettings();
                }, 500);
            }
        })();
    </script>
    
    </div>
    <!-- End Auth Protected Content -->
</body>
</html>
